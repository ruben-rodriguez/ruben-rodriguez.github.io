<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Ruben"><meta name=description content="Endpoints Monitoring leveraging BlackBox Exporter"><meta name=keywords content="homepage,blog,Monitoring,Prometheus,Kubernetes"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://ruben-rodriguez.github.io/posts/kube-prom-stack-blackbox/><title>Endpoints Monitoring - BlackBox Exporter :: Ruben Rodriguez — Some personal notes and random thoughts</title><link rel=stylesheet href=/main.min.7289daf2e88ea2c7b253a51cc5794c7cc17e7aeb7295a19d978db764a5862f25.css integrity="sha256-cona8uiOoseyU6UcxXlMfMF+eutylaGdl423ZKWGLyU=" crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Endpoints Monitoring - BlackBox Exporter"><meta itemprop=description content="Endpoints Monitoring leveraging BlackBox Exporter"><meta itemprop=datePublished content="2022-05-24T00:00:00+08:00"><meta itemprop=dateModified content="2022-05-24T00:00:00+08:00"><meta itemprop=wordCount content="455"><meta itemprop=image content="https://ruben-rodriguez.github.io/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ruben-rodriguez.github.io/"><meta name=twitter:title content="Endpoints Monitoring - BlackBox Exporter"><meta name=twitter:description content="Endpoints Monitoring leveraging BlackBox Exporter"><meta property="article:published_time" content="2022-05-24 00:00:00 +0800 +0800"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p></p></div><article><h1 class=post-title><a href=https://ruben-rodriguez.github.io/posts/kube-prom-stack-blackbox/>Endpoints Monitoring - BlackBox Exporter</a></h1><div class=post-excerpt>Endpoints Monitoring leveraging BlackBox Exporter</div><div class=post-content><p>Endpoints monitoring is an important part of the infrastructure observability for discovering availability and performance problems.
In this small post, I&rsquo;ll go through the general steps to setup Blackbox exporter leveraging the kube-prometheus-stack.</p><p><a href=https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack>kube-prometheus-stack</a> is a collection of manifests and components, including Grafana dashboards and Prometheus rules targeting the monitoring of a Kubernetes cluster. In general, the Prometheus monitoring stack consists of several scrappable endpoints that collect metrics called exporters, Prometheus itself to collect and store those metrics, and Grafana, which provides visualization of the data stored leveraging the PromQL query language:</p><p><img src=/img/posts/kube-prom-stack-blackbox/kube-prom-stack-blackbox.png alt></p><blockquote><p>Diagram made with one of my favourite tools, <a href=https://excalidraw.com/>Excalidraw</a></p></blockquote><p>In order to collect different system metrics, the figure of exporters is one of the most important parts of Prometheus monitoring stack. There are many exporters out there and, in case you can&rsquo;t find one for the purpose you are seeking, you are very welcomed to develop your own metric exporter (there are a number of libraries for different programming languages that ease this task).</p><p>Now, let&rsquo;s get down to business!</p><p>First, we will install the blackbox exporter leveraging Helm. Remember you can customize the Blackbox exporter configuration by providing your own <code>values.yaml</code> file based on the supported <a href=https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml>values</a>. I&rsquo;ll install it in the monitoring namespace of my cluster, hence <code>-n monitoring</code> parameter passed to Helm:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm install blackbox-exporter prometheus-community/prometheus-blackbox-exporter -n monitoring
</span></span></code></pre></div><blockquote><p>Please note that Helm release name matters in terms of DNS names and we will need that to refer the Blackbox exporter in the next step!</p></blockquote><p>Once Blackbox Helm chart is installed, we go on to install Prometheus stack Helm chart, but adding some additional scrapping configuration in its own <code>values.yaml</code> <a href=https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml>file</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>prometheus</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>prometheusSpec</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>additionalScrapeConfigs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>blackbox</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/probe</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>module</span>: [<span style=color:#ae81ff>http_2xx]</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>          <span style=color:#75715e># Blackbox targets to scrape</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>https://www.google.com</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>https://ruben-rodriguez.github.io</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__param_target</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__param_target]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>target</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># This is what makes blackbox exporter reachable from Prometheus</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>blackbox-exporter-prometheus-blackbox-exporter:9115</span>
</span></span></code></pre></div><p>And install with Helm (if you executed previous helm repo commands, you can skip these ones):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --values values.yaml
</span></span></code></pre></div><p>After Prometheus is installed, it should be scrapping the Blackbox exporter, you can check by port-forwarding the Prometheus service in the Cluster to a port in your machine with <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward svc/prometheus-kube-prometheus-prometheus 3000:9090
</span></span></code></pre></div><p>Once you access http://localhost:3000/, in the Targets section of Prometheus, we should see the Blackbox exporter endpoints:</p><p><img src=/img/posts/kube-prom-stack-blackbox/targets.png alt></p><p>Furthermore, the metrics available for these endpoints can now be queried:</p><p><img src=/img/posts/kube-prom-stack-blackbox/probes.png alt></p><p><img src=/img/posts/kube-prom-stack-blackbox/probes-example.png alt></p><p>And that&rsquo;s it, now you can start querying these metrics from Grafana and craft some awesome dashboards, or you can try one of the availables in <a href="https://grafana.com/grafana/dashboards/?search=Blackbox">Grafana Dashboards page</a></p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/monitoring/>Monitoring</a></span>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/prometheus/>Prometheus</a></span>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/kubernetes/>Kubernetes</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
455 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2022-05-23 16:00</p></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://ruben-rodriguez.github.io/posts/archlinux-zbook-installation-notes/><span class=button__icon>←</span>
<span class=button__text>Arch Linux on... HP Zbook</span>
</a></span><span class="button next"><a href=https://ruben-rodriguez.github.io/posts/manjaro-kernel/><span class=button__text>Linux Kernel - Manjaro breaking dependencies</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.08b680078a3cf9c69e3dd217a5aa52cfddd4a1d850f8cdff127fdd7421a71f8b2b474be69386f67819edace92273916e7230c9054f38107db9dc6730b3530ab5.js integrity="sha512-CLaAB4o8+caePdIXpapSz93UodhQ+M3/En/ddCGnH4srR0vmk4b2eBntrOkic5FucjDJBU84EH253Gcws1MKtQ=="></script></body></html>