<!doctype html><html lang=en><head><title>Endpoints Monitoring - BlackBox Exporter ::
Ruben Rodriguez — Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Endpoints monitoring is an important part of the infrastructure observability for discovering availability and performance problems. In this small post, I&amp;rsquo;ll go through the general steps to setup Blackbox exporter leveraging the kube-prometheus-stack.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/kube-prom-stack-blackbox/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Endpoints Monitoring - BlackBox Exporter"><meta name=twitter:description content="Endpoints Monitoring leveraging BlackBox Exporter"><meta property="og:title" content="Endpoints Monitoring - BlackBox Exporter"><meta property="og:description" content="Endpoints Monitoring leveraging BlackBox Exporter"><meta property="og:type" content="article"><meta property="og:url" content="/posts/kube-prom-stack-blackbox/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-24T00:00:00+08:00"><meta property="article:modified_time" content="2022-05-24T00:00:00+08:00"><meta property="og:site_name" content="Ruben Rodriguez"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Endpoints Monitoring - BlackBox Exporter</h1><div class=post-meta><span class=post-date>2022-05-24</span>
<span class=post-author>— Written by Ruben</span></div><span class=post-tags><a href=/tags/monitoring/>#Monitoring</a>&nbsp;
<a href=/tags/prometheus/>#Prometheus</a>&nbsp;
<a href=/tags/kubernetes/>#Kubernetes</a>&nbsp;</span><div class=post-content><p>Endpoints monitoring is an important part of the infrastructure observability for discovering availability and performance problems.
In this small post, I&rsquo;ll go through the general steps to setup Blackbox exporter leveraging the kube-prometheus-stack.</p><p><a href=https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack>kube-prometheus-stack</a> is a collection of manifests and components, including Grafana dashboards and Prometheus rules targeting the monitoring of a Kubernetes cluster. In general, the Prometheus monitoring stack consists of several scrappable endpoints that collect metrics called exporters, Prometheus itself to collect and store those metrics, and Grafana, which provides visualization of the data stored leveraging the PromQL query language:</p><p><img src=/img/posts/kube-prom-stack-blackbox/kube-prom-stack-blackbox.png alt></p><blockquote><p>Diagram made with one of my favourite tools, <a href=https://excalidraw.com/>Excalidraw</a></p></blockquote><p>In order to collect different system metrics, the figure of exporters is one of the most important parts of Prometheus monitoring stack. There are many exporters out there and, in case you can&rsquo;t find one for the purpose you are seeking, you are very welcomed to develop your own metric exporter (there are a number of libraries for different programming languages that ease this task).</p><p>Now, let&rsquo;s get down to business!</p><p>First, we will install the blackbox exporter leveraging Helm. Remember you can customize the Blackbox exporter configuration by providing your own <code>values.yaml</code> file based on the supported <a href=https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml>values</a>. I&rsquo;ll install it in the monitoring namespace of my cluster, hence <code>-n monitoring</code> parameter passed to Helm:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm install blackbox-exporter prometheus-community/prometheus-blackbox-exporter -n monitoring
</span></span></code></pre></div><blockquote><p>Please note that Helm release name matters in terms of DNS names and we will need that to refer the Blackbox exporter in the next step!</p></blockquote><p>Once Blackbox Helm chart is installed, we go on to install Prometheus stack Helm chart, but adding some additional scrapping configuration in its own <code>values.yaml</code> <a href=https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml>file</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>prometheus</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>prometheusSpec</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>additionalScrapeConfigs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>blackbox</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>metrics_path</span>: <span style=color:#ae81ff>/probe</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>params</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>module</span>: [<span style=color:#ae81ff>http_2xx]</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>          <span style=color:#75715e># Blackbox targets to scrape</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>https://www.google.com</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>https://ruben-rodriguez.github.io</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__param_target</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__param_target]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>target</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># This is what makes blackbox exporter reachable from Prometheus</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>blackbox-exporter-prometheus-blackbox-exporter:9115</span>
</span></span></code></pre></div><p>And install with Helm (if you executed previous helm repo commands, you can skip these ones):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --values values.yaml
</span></span></code></pre></div><p>After Prometheus is installed, it should be scrapping the Blackbox exporter, you can check by port-forwarding the Prometheus service in the Cluster to a port in your machine with <code>kubectl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl port-forward svc/prometheus-kube-prometheus-prometheus 3000:9090
</span></span></code></pre></div><p>Once you access http://localhost:3000/, in the Targets section of Prometheus, we should see the Blackbox exporter endpoints:</p><p><img src=/img/posts/kube-prom-stack-blackbox/targets.png alt></p><p>Furthermore, the metrics available for these endpoints can now be queried:</p><p><img src=/img/posts/kube-prom-stack-blackbox/probes.png alt></p><p><img src=/img/posts/kube-prom-stack-blackbox/probes-example.png alt></p><p>And that&rsquo;s it, now you can start querying these metrics from Grafana and craft some awesome dashboards, or you can try one of the availables in <a href="https://grafana.com/grafana/dashboards/?search=Blackbox">Grafana Dashboards page</a></p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/archlinux-zbook-installation-notes/><span class=button__icon>←</span>
<span class=button__text>Arch Linux on... HP Zbook</span></a></span>
<span class="button next"><a href=/posts/manjaro-kernel/><span class=button__text>Linux Kernel - Manjaro breaking dependencies</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>