<!doctype html><html lang=en><head><title>Selfhosted S3 Terraform Backend using MinIO ::
Ruben Rodriguez — Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Context # In one of my homelab servers I make a heavy use of Docker containers (yes, plain Docker) to provide different tools and applications. At this time, I was looking for a way of moving Terraform state files from the cloud to my home controlled infrastructure to reduce costs. I already knew that there were different implementations of the AWS S3 object storage system, Cepth and MinIO, so I decided to test MinIO."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/minio-s3-terraform-backend/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Selfhosted S3 Terraform Backend using MinIO"><meta name=twitter:description content="Using MinIO as S3 backend for Terraform state"><meta property="og:title" content="Selfhosted S3 Terraform Backend using MinIO"><meta property="og:description" content="Using MinIO as S3 backend for Terraform state"><meta property="og:type" content="article"><meta property="og:url" content="/posts/minio-s3-terraform-backend/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-13T00:00:00+08:00"><meta property="article:modified_time" content="2022-08-13T00:00:00+08:00"><meta property="og:site_name" content="Ruben Rodriguez"><meta name=google-site-verification content="6jS-Osezzv4luRDVRg4jM8iulRYMMuOGdU-httJV8Ig"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Selfhosted S3 Terraform Backend using MinIO</h1><div class=post-meta><span class=post-date>2022-08-13</span>
<span class=post-author>— Written by Ruben</span></div><span class=post-tags><a href=/tags/iac/>#IaC</a>&nbsp;
<a href=/tags/terraform/>#Terraform</a>&nbsp;
<a href=/tags/docker/>#Docker</a>&nbsp;
<a href=/tags/selhosted/>#Selhosted</a>&nbsp;</span><div class=post-content><h2 id=context>Context
<a href=#context class=h-anchor aria-hidden=true>#</a></h2><p>In one of my homelab servers I make a heavy use of Docker containers (yes, plain Docker) to provide different tools and applications.
At this time, I was looking for a way of moving Terraform state files from the cloud to my home controlled infrastructure to reduce costs.
I already knew that there were different implementations of the AWS S3 object storage system, Cepth and MinIO, so I decided to test MinIO.</p><h2 id=minio-deployment>MinIO Deployment
<a href=#minio-deployment class=h-anchor aria-hidden=true>#</a></h2><p>As usual, I put the MinIO deployment into a <code>docker-compose.yaml</code> like the one below which makes MinIO available considering:</p><ul><li>It&rsquo;s behind Traefik proxy.</li><li><code>proxy</code> network is Traefik network.</li><li>I pass <code>MINIO_BROWSER_REDIRECT_URL</code> so that when reaching <code>s3.domain.local</code> with a browser it redirects to the MinIO management console.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>minio</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>minio/minio:&lt;tag&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>server</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      - --<span style=color:#ae81ff>console-address</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;:9001&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>MINIO_BROWSER_REDIRECT_URL=http://s3-console.domain.local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>&lt;/host/path&gt;:/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio.entrypoints=http&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio.service=minio&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio.rule=Host(`s3.domain.local`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.minio.loadbalancer.server.port=9000&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio-console.service=minio-console&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio-console.rule=Host(`s3-console.domain.local`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.minio-console.loadbalancer.server.port=9001&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Once the Docker resources are created (container running), you can access the Management console (<code>s3.domain.local</code> or <code>s3-console.domain.local</code>) with the default admin credentials <code>minioadmin:minioadmin</code> or use the <a href=https://docs.min.io/docs/minio-client-complete-guide.html>MinIO CLI</a></p><h2 id=s3-bucket-creation>S3 Bucket Creation
<a href=#s3-bucket-creation class=h-anchor aria-hidden=true>#</a></h2><p>Once logged into the MinIO management console, I performed the following actions:</p><ul><li>From the Buckets section, I created a bucket named <code>tfstate</code>.</li><li>From the Identity section, I created a Service Accounts, noting down the access and secret keys.</li></ul><h2 id=terraform-backend-configuration>Terraform Backend configuration
<a href=#terraform-backend-configuration class=h-anchor aria-hidden=true>#</a></h2><p>Finally, to make use of the S3 bucket as backend for a terraform project, you configure Terraform like the following example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>terraform {</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>backend &#34;s3&#34; {</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>bucket = &#34;tfstate&#34;                 </span> <span style=color:#75715e># Name of the S3 bucket</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>endpoint = &#34;http://s3.domain.local&#34;</span> <span style=color:#75715e># Minio endpoint</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>key = &#34;project-name.tfstate&#34;       </span> <span style=color:#75715e># Name of the tfstate file</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>access_key=&#34;xxxxxxxxxxxx&#34;          </span> <span style=color:#75715e># Access and secret keys</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>secret_key=&#34;xxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>region = &#34;main&#34;                    </span> <span style=color:#75715e># Region validation will be skipped</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_credentials_validation = true </span> <span style=color:#75715e># Skip AWS related checks and validations</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_metadata_api_check = true</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_region_validation = true</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>force_path_style = true            </span> <span style=color:#75715e># Enable path-style S3 URLs (https://&lt;HOST&gt;/&lt;BUCKET&gt; https://www.terraform.io/language/settings/backends/s3#force_path_style</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>More details can be found in the official <a href=https://www.terraform.io/language/settings/backends/s3>Terraform S3 Backend documentation</a>.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/archlinux-zbook-installation-notes/><span class=button__text>Arch Linux on... HP Zbook</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>