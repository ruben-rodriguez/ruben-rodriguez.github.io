<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Ruben"><meta name=description content="How to use MinIO as S3 backend for Terraform state"><meta name=keywords content="homepage,blog,IaC,Terraform,Docker,Selhosted"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://ruben-rodriguez.github.io/posts/minio-s3-terraform-backend/><title>Selfhosted S3 Terraform Backend using MinIO :: Ruben Rodriguez — Some personal notes and random thoughts</title><link rel=stylesheet href=/main.min.7289daf2e88ea2c7b253a51cc5794c7cc17e7aeb7295a19d978db764a5862f25.css integrity="sha256-cona8uiOoseyU6UcxXlMfMF+eutylaGdl423ZKWGLyU=" crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Selfhosted S3 Terraform Backend using MinIO"><meta itemprop=description content="How to use MinIO as S3 backend for Terraform state"><meta itemprop=datePublished content="2022-08-13T00:00:00+08:00"><meta itemprop=dateModified content="2022-08-13T00:00:00+08:00"><meta itemprop=wordCount content="356"><meta itemprop=image content="https://ruben-rodriguez.github.io/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ruben-rodriguez.github.io/"><meta name=twitter:title content="Selfhosted S3 Terraform Backend using MinIO"><meta name=twitter:description content="How to use MinIO as S3 backend for Terraform state"><meta property="article:published_time" content="2022-08-13 00:00:00 +0800 +0800"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p></p></div><article><h1 class=post-title><a href=https://ruben-rodriguez.github.io/posts/minio-s3-terraform-backend/>Selfhosted S3 Terraform Backend using MinIO</a></h1><div class=post-excerpt>How to use MinIO as S3 backend for Terraform state</div><div class=post-content><h2 id=context>Context</h2><p>In one of my homelab servers I make a heavy use of Docker containers (yes, plain Docker) to provide different tools and applications.
At this time, I was looking for a way of moving Terraform state files from the cloud to my home controlled infrastructure to reduce costs.
I already knew that there were different implementations of the AWS S3 object storage system, Cepth and MinIO, so I decided to test MinIO.</p><h2 id=minio-deployment>MinIO Deployment</h2><p>As usual, I put the MinIO deployment into a <code>docker-compose.yaml</code> like the one below which makes MinIO available considering:</p><ul><li>It&rsquo;s behind Traefik proxy.</li><li><code>proxy</code> network is Traefik network.</li><li>I pass <code>MINIO_BROWSER_REDIRECT_URL</code> so that when reaching <code>s3.domain.local</code> with a browser it redirects to the MinIO management console.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>minio</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>minio/minio:&lt;tag&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>server</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>      - --<span style=color:#ae81ff>console-address</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;:9001&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>MINIO_BROWSER_REDIRECT_URL=http://s3-console.domain.local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>&lt;/host/path&gt;:/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio.entrypoints=http&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio.service=minio&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio.rule=Host(`s3.domain.local`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.minio.loadbalancer.server.port=9000&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio-console.service=minio-console&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.minio-console.rule=Host(`s3-console.domain.local`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.minio-console.loadbalancer.server.port=9001&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Once the Docker resources are created (container running), you can access the Management console (<code>s3.domain.local</code> or <code>s3-console.domain.local</code>) with the default admin credentials <code>minioadmin:minioadmin</code> or use the <a href=https://docs.min.io/docs/minio-client-complete-guide.html>MinIO CLI</a></p><h2 id=s3-bucket-creation>S3 Bucket Creation</h2><p>Once logged into the MinIO management console, I performed the following actions:</p><ul><li>From the Buckets section, I created a bucket named <code>tfstate</code>.</li><li>From the Identity section, I created a Service Accounts, noting down the access and secret keys.</li></ul><h2 id=terraform-backend-configuration>Terraform Backend configuration</h2><p>Finally, to make use of the S3 bucket as backend for a terraform project, you configure Terraform like the following example (recently updated for Terraform 1.6.6):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>terraform {</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>backend &#34;s3&#34; {</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>bucket = &#34;tfstate&#34;                 </span> <span style=color:#75715e># Name of the S3 bucket</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>endpoints = {</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>s3 = &#34;http://s3.domain.local&#34;  </span> <span style=color:#75715e># Minio endpoint</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>key = &#34;project-name.tfstate&#34;       </span> <span style=color:#75715e># Name of the tfstate file</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>access_key=&#34;xxxxxxxxxxxx&#34;          </span> <span style=color:#75715e># Access and secret keys</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>secret_key=&#34;xxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>region = &#34;main&#34;                    </span> <span style=color:#75715e># Region validation will be skipped</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_credentials_validation = true </span> <span style=color:#75715e># Skip AWS related checks and validations</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_requesting_account_id = true</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_metadata_api_check = true</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>skip_region_validation = true</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>use_path_style = true            </span> <span style=color:#75715e># Enable path-style S3 URLs (https://&lt;HOST&gt;/&lt;BUCKET&gt; https://developer.hashicorp.com/terraform/language/settings/backends/s3#use_path_style</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>More details can be found in the official <a href=https://www.terraform.io/language/settings/backends/s3>Terraform S3 Backend documentation</a>.</p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/iac/>IaC</a></span>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/terraform/>Terraform</a></span>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/docker/>Docker</a></span>
<span class=tag><a href=https://ruben-rodriguez.github.io/tags/selhosted/>Selhosted</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
356 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2022-08-12 16:00</p></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://ruben-rodriguez.github.io/posts/ingress-nginx-server-side-includes/><span class=button__icon>←</span>
<span class=button__text>Micro-frontends and Ingress Nginx - Server Side Includes</span>
</a></span><span class="button next"><a href=https://ruben-rodriguez.github.io/posts/archlinux-zbook-installation-notes/><span class=button__text>Arch Linux on... HP Zbook</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.08b680078a3cf9c69e3dd217a5aa52cfddd4a1d850f8cdff127fdd7421a71f8b2b474be69386f67819edace92273916e7230c9054f38107db9dc6730b3530ab5.js integrity="sha512-CLaAB4o8+caePdIXpapSz93UodhQ+M3/En/ddCGnH4srR0vmk4b2eBntrOkic5FucjDJBU84EH253Gcws1MKtQ=="></script></body></html>