<!doctype html><html lang=en><head><title>Arch Linux on... HP Zbook ::
Ruben Rodriguez — Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Context # HP Zbook workstations are one of my favorites battle ready laptops out there (besides Dell XPS developer edition). I&amp;rsquo;m yet to put my hands on a future ready ultrabook like the SLIMBOOKs. Now, if I want to tackle some serious business with this beast (like ricing i3, edit YAML files or develop some funny golang pointless app) I will need to install my favorite OS of all time!"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://ruben-rodriguez.github.io/posts/archlinux-zbook-installation-notes/><link rel=stylesheet href=https://ruben-rodriguez.github.io/assets/style.css><link rel=stylesheet href=https://ruben-rodriguez.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://ruben-rodriguez.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://ruben-rodriguez.github.io/img/favicon.png><link href=https://ruben-rodriguez.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://ruben-rodriguez.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://ruben-rodriguez.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://ruben-rodriguez.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://ruben-rodriguez.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://ruben-rodriguez.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Arch Linux on... HP Zbook"><meta name=twitter:description content="Arch Linux installation notes for HP Zbook (dualboot)"><meta property="og:title" content="Arch Linux on... HP Zbook"><meta property="og:description" content="Arch Linux installation notes for HP Zbook (dualboot)"><meta property="og:type" content="article"><meta property="og:url" content="https://ruben-rodriguez.github.io/posts/archlinux-zbook-installation-notes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-25T00:00:00+08:00"><meta property="article:modified_time" content="2022-07-25T00:00:00+08:00"><meta property="og:site_name" content="Ruben Rodriguez"><meta name=google-site-verification content="6jS-Osezzv4luRDVRg4jM8iulRYMMuOGdU-httJV8Ig"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Arch Linux on&mldr; HP Zbook</h1><div class=post-meta><span class=post-date>2022-07-25</span>
<span class=post-author>— Written by Ruben</span></div><span class=post-tags><a href=https://ruben-rodriguez.github.io/tags/arch-linux/>#Arch Linux</a>&nbsp;
<a href=https://ruben-rodriguez.github.io/tags/installation/>#Installation</a>&nbsp;
<a href=https://ruben-rodriguez.github.io/tags/zbook/>#Zbook</a>&nbsp;
<a href=https://ruben-rodriguez.github.io/tags/laptops/>#Laptops</a>&nbsp;</span><div class=post-content><h2 id=context>Context
<a href=#context class=h-anchor aria-hidden=true>#</a></h2><p>HP Zbook workstations are one of my favorites battle ready laptops out there (besides Dell XPS developer edition). I&rsquo;m yet to put my hands on a future ready ultrabook like the <a href=https://slimbook.es/>SLIMBOOKs</a>. Now, if I want to tackle some serious business with this beast (like ricing i3, edit YAML files or develop some funny golang pointless app) I will need to install my favorite OS of all time!</p><p>The situation at hand is:</p><ul><li>I just got an HP Zbook Power G8 workstation laptop.</li><li>It has Windows 10 preinstalled.</li><li>I want to keep the Windows installation, meaning, I need a dualboot setup.</li></ul><p>The main issue of having Windows 10 preinstalled in the machine is that, by default, Windows installer creates an absurdly small EFI partition of 100MB. This partition holds the different OS bootloaders while booting in UEFI mode. Of course, you can try, but most probably you will fail while setting up a dualboot when executing the <code>mkinitcpio</code> script used to create the initial ramdisk to the EFI (/boot) partition because it has not enough space left to store the files.</p><h2 id=extend-efi-partition>Extend EFI partition
<a href=#extend-efi-partition class=h-anchor aria-hidden=true>#</a></h2><p>In my case, I had no other choice than extending the EFI partition. And, yet another issue we find in our way! GParted (which uses libparted) is <a href="https://bugzilla.gnome.org/show_bug.cgi?id=649324#c4">not able</a> to resize FAT32 (format of EFI) partitions that are less than 256MB in size. As suggested in the bug comments, I followed these steps:</p><ol><li>Backup the data in the FAT16/FAT32 partition; you can use a USB stick and a live Arch ISO, and execute, for example:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ mount /dev/sdx1 /mnt <span style=color:#75715e># Mount your EFI partition, replace sdx1 with ESP/EFI partition</span>
</span></span><span style=display:flex><span>λ mkdir usb
</span></span><span style=display:flex><span>λ mount /dev/sdx1 usb  <span style=color:#75715e># Mount your USB stick (you might need flags like -t exfat for mounting)</span>
</span></span><span style=display:flex><span>λ rsync -av /mnt/ usb/ <span style=color:#75715e># Copy EFI partition files to the USB</span>
</span></span><span style=display:flex><span>λ ls usb/              <span style=color:#75715e># Check USB contents</span>
</span></span><span style=display:flex><span>λ umount /mnt          <span style=color:#75715e># Umount the EFI partition</span>
</span></span></code></pre></div><ol start=2><li>Reformat the partition to EXT4; for this, you can use GParted live or <code>gdisk</code> commands.</li><li>Resize EXT4 partition to desired partition size; again, you can use GParted for this.</li><li>Reformat the partition back to FAT16/FAT32; important bit here is to set the partition type (flags) accordingly (boot and esp)</li><li>Restore the FAT16/FAT32 files from backup:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ mount /dev/sdx1 /mnt <span style=color:#75715e># Mount your EFI partition, replace sdx1 with ESP/EFI partition</span>
</span></span><span style=display:flex><span>λ mkdir usb
</span></span><span style=display:flex><span>λ mount /dev/sdx1 usb  <span style=color:#75715e># Mount your USB stick (you might need flags like -t exfat for mounting)</span>
</span></span><span style=display:flex><span>λ rsync -av /mnt/ usb/ <span style=color:#75715e># Copy EFI partition files to the USB</span>
</span></span><span style=display:flex><span>λ ls usb/              <span style=color:#75715e># Check USB contents</span>
</span></span><span style=display:flex><span>λ umount /mnt          <span style=color:#75715e># Umount the EFI partition</span>
</span></span></code></pre></div><p>In my case, after doing a backup of the EFI partition files with Arch Linux Live installation media to a USB, I booted into GParted live and performed the following actions (using the GUI):</p><ol><li>Resized Windows main partition (half disk)</li><li>Moved Windows main partition to the right by 2GB (this takes about 10 minutes to complete)</li><li>Formatted EFI partition to ext4</li><li>Extended EFI partition 2GB to the right (the free space made available by moving Windows main partition to the right)</li><li>Formatted EFI partition back to FAT32 and set <code>boot</code> and <code>esp</code> flags to the partition.</li></ol><p>Finally, I booted Arch Linux live installation media and restored EFI/ESP backup files to the new resized EFI partition. Afterwards, I proceeded to install Arch Linux.</p><h2 id=arch-linux-installation>Arch Linux Installation
<a href=#arch-linux-installation class=h-anchor aria-hidden=true>#</a></h2><p>Basically I followed the <a href=https://wiki.archlinux.org/title/installation_guide>Arch Linux installation guide</a>.</p><h3 id=boot-loader>Boot Loader
<a href=#boot-loader class=h-anchor aria-hidden=true>#</a></h3><p>In terms of boot manager, I chose GRUB (the one I&rsquo;m most familiar with) and followed these steps to also detect the Windows installation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ pacman -S grub efibootmgr os-prober
</span></span><span style=display:flex><span>λ grub-install --target<span style=color:#f92672>=</span>x86_64-efi --efi-directory<span style=color:#f92672>=</span>/boot --bootloader-id<span style=color:#f92672>=</span>GRUB
</span></span><span style=display:flex><span>λ os-prober <span style=color:#75715e># To check that Windows was in fact detected</span>
</span></span><span style=display:flex><span>λ vim /boot/grub/grub.cfg <span style=color:#75715e># Edit GRUB config </span>
</span></span><span style=display:flex><span><span style=color:#75715e># Uncomment GRUB_DISABLE_OS_PROBER=false so grub adds an entry for Windows installation</span>
</span></span><span style=display:flex><span>λ grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>At this point, I was able to boot into the new Archlinux installation and perform post-installation activities.</p><h3 id=enabling-aur>Enabling AUR
<a href=#enabling-aur class=h-anchor aria-hidden=true>#</a></h3><p>This is a standard step I always run to be able to access the AUR (Arch User Repository)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo git clone https://aur.archlinux.org/yay.git
</span></span><span style=display:flex><span>λ cd yay/
</span></span><span style=display:flex><span>λ sudo makepkg -si
</span></span><span style=display:flex><span>λ yay -Syu
</span></span></code></pre></div><h3 id=graphics-driver>Graphics Driver
<a href=#graphics-driver class=h-anchor aria-hidden=true>#</a></h3><p>This topic is also somehow special for this machine. The specifications for HP Zbook Power G8 shows that it has two GPUs, Intel graphics (integrated) and NVIDIA GPU (dedicated). <a href=https://wiki.archlinux.org/title/NVIDIA_Optimus>NVIDIA Optimus</a> allows these beast laptops that have dedicated GPUs to access both graphic cards depending on the task being run. Unfortunately, there is no support for this technology in Linux out of the box, and there are different options available (can be checked in the Arch Linux <a href=https://wiki.archlinux.org/title/NVIDIA_Optimus#Available_methods>wiki</a>). I chose to have access to both integrated & dedicated graphics and I installed <a href=https://github.com/Askannz/optimus-manager>Optimus Manager</a> (available in the AUR) which is a program aimed to provide an easy way to switch GPU modes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo pacman -S nvidia
</span></span><span style=display:flex><span>λ sudo pacman -S xorg xorg-apps
</span></span><span style=display:flex><span>λ yay -S optimus-manager optimus-manager-qt
</span></span><span style=display:flex><span><span style=color:#75715e># Reboot</span>
</span></span><span style=display:flex><span>λ optimus-manager --switch nvidia 
</span></span><span style=display:flex><span>λ  optimus-manager --status
</span></span><span style=display:flex><span>Optimus Manager <span style=color:#f92672>(</span>Client<span style=color:#f92672>)</span> version 1.4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Current GPU mode : nvidia
</span></span><span style=display:flex><span>GPU mode requested <span style=color:#66d9ef>for</span> next login : no change
</span></span><span style=display:flex><span>GPU at startup : auto
</span></span><span style=display:flex><span>Temporary config path: no
</span></span></code></pre></div><p>I configured optimus (with the help of <code>optimus-manager-qt</code>) so when the laptop is started with battery it will use integrated graphis and the other way arround:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ  cat /etc/optimus-manager/optimus-manager.conf
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>amd<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>DRI<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>driver<span style=color:#f92672>=</span>modesetting
</span></span><span style=display:flex><span>tearfree<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>intel<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>DRI<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>accel<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>driver<span style=color:#f92672>=</span>modesetting
</span></span><span style=display:flex><span>modeset<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>tearfree<span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>nvidia<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>DPI<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span>
</span></span><span style=display:flex><span>PAT<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>allow_external_gpus<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>dynamic_power_management<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>ignore_abi<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>modeset<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>options<span style=color:#f92672>=</span>overclocking
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>optimus<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>auto_logout<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>pci_power_control<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>pci_remove<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>pci_reset<span style=color:#f92672>=</span>hot_reset
</span></span><span style=display:flex><span>startup_auto_battery_mode<span style=color:#f92672>=</span>integrated
</span></span><span style=display:flex><span>startup_auto_extpower_mode<span style=color:#f92672>=</span>nvidia
</span></span><span style=display:flex><span>startup_mode<span style=color:#f92672>=</span>auto
</span></span><span style=display:flex><span>switching<span style=color:#f92672>=</span>none
</span></span></code></pre></div><blockquote><p>At the time of this installation, <a href=https://bugs.archlinux.org/task/74886>nvidia may not boot</a> on Linux 5.18 (or later) on systems with Intel CPUs. When changing to hybrid or nvidia graphics mode with <code>envycontrol</code> you may find a blank screen. To solve it, you can boot a live CD installation and chroot into it to execute <code>envycontrol</code> and change back to the integrated graphics mode.</p></blockquote><p>Checking the logs from previous boot you will find something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ  journalctl -b-3
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>traps: Missing ENDBR: _nv011889rm+0x0/0x10 <span style=color:#f92672>[</span>nvidia<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>kernel: ------------<span style=color:#f92672>[</span> cut here <span style=color:#f92672>]</span>------------
</span></span><span style=display:flex><span>kernel: kernel BUG at arch/x86/kernel/traps.c:253!
</span></span><span style=display:flex><span>systemd<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: Failed to start Load Kernel Modules.
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Until this is fixed, a workaround is disabling the Indirect Branch Tracking CPU security feature by setting the <code>ibt=off</code> kernel parameter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ  vim /etc/default/grub
</span></span><span style=display:flex><span>GRUB_CMDLINE_LINUX_DEFAULT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;loglevel=3 quiet ibt=off&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>λ  grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h2 id=customizations--tweaks>Customizations & Tweaks
<a href=#customizations--tweaks class=h-anchor aria-hidden=true>#</a></h2><p>This is more of a personal taste and involves my usual setup of basic tools (window manager, sound control, etc)</p><h3 id=window-manager-vs-desktop-environment>Window Manager vs. Desktop Environment
<a href=#window-manager-vs-desktop-environment class=h-anchor aria-hidden=true>#</a></h3><p>Ever since I tried a Window Manager (i3), I have not been able to go back to a proper DE (I&rsquo;ve used GNOME, Cinammon and, lately, KDE Plasma). Whenever I try a DE, I feel really slow using the machine. For that reason, I find myself really comfortable using i3 WM and the usual tools that are installed with it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo pacman -S i3
</span></span></code></pre></div><h3 id=login>Login
<a href=#login class=h-anchor aria-hidden=true>#</a></h3><p>I also installed <a href=https://wiki.archlinux.org/title/LightDM#Installation>ligthdm</a> to perform the login (autologin)</p><pre tabindex=0><code># /etc/lightdm/lightdm.conf
[Seat:*]
autologin-user=username
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ groupadd -r autologin
</span></span><span style=display:flex><span>λ gpasswd -a username autologin
</span></span></code></pre></div><h3 id=sound>Sound
<a href=#sound class=h-anchor aria-hidden=true>#</a></h3><p>The only issue I found after completing the installation was that no sound card was detected by issuing</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ cat /proc/asound/cards
</span></span></code></pre></div><p>Installing the <a href=https://www.sofproject.org/>Sound Open Firmware</a> solved the issue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo pacman -S sof-firmware
</span></span><span style=display:flex><span>λ cat /proc/asound/cards
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#f92672>[</span>sofhdadsp<span style=color:#f92672>]</span>: sof-hda-dsp - sof-hda-dsp
</span></span><span style=display:flex><span>        HP-HPZBookPower15.6inchG8MobileWorkstationPC
</span></span></code></pre></div><p>I also installed <code>pulseadio</code> and <code>pa-applet</code> to be able to control the volume of the default device. Also, so that function keys work, <code>dunst</code>, a lightweight replacement for the notification-daemons provided by most desktop environments, is required:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo pacman -S pulseaudio dunst
</span></span><span style=display:flex><span>λ yay -S pa-applet-git
</span></span></code></pre></div><h3 id=brightness>Brightness
<a href=#brightness class=h-anchor aria-hidden=true>#</a></h3><p>For controlling the display brightness, I installed <code>brightnessctl</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo pacman -S brightnessctl
</span></span><span style=display:flex><span>λ brightnessctl set 50%
</span></span></code></pre></div><p>You can then add keybindings to your i3 config file:</p><pre tabindex=0><code>bindsym XF86MonBrightnessDown exec &#34;brightnessctl set 10%-; notify-send &#39;brightness down&#39;&#34;
bindsym XF86MonBrightnessUp exec &#34;brightnessctl set +10%; notify-send &#39;brightness up&#39;&#34;
</code></pre><h3 id=bonus-root-partition-encryption>[BONUS] Root partition encryption
<a href=#bonus-root-partition-encryption class=h-anchor aria-hidden=true>#</a></h3><p>This is something I always do on laptop installations that are subject to be stolen or lost in the wild.
I usually do it at installation time, though sometimes I forget and I&rsquo;m forced to do it afterwards using this <a href=https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#Encrypt_an_existing_unencrypted_file_system>article</a> from our beloved Arch Wiki.
I followed these steps:</p><ol><li>Perform a backup using your favorite method, I used <a href=https://wiki.archlinux.org/title/Rsync#As_a_backup_utility><code>rsync</code></a>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ rsync -aAXHv --exclude<span style=color:#f92672>={</span><span style=color:#e6db74>&#34;/dev/*&#34;</span>,<span style=color:#e6db74>&#34;/proc/*&#34;</span>,<span style=color:#e6db74>&#34;/sys/*&#34;</span>,<span style=color:#e6db74>&#34;/tmp/*&#34;</span>,<span style=color:#e6db74>&#34;/run/*&#34;</span>,<span style=color:#e6db74>&#34;/mnt/*&#34;</span>,<span style=color:#e6db74>&#34;/media/*&#34;</span>,<span style=color:#e6db74>&#34;/lost+found&#34;</span><span style=color:#f92672>}</span> / /path/to/backup
</span></span></code></pre></div><ol start=2><li>Then, boot a live Arch iso and make room for the encryption (LUKS) headers; I resized the root filesystem by 1GB, more than enough (about 16Mb) required</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ resize2fs /dev/sdXY 399G <span style=color:#75715e>#(400 - 1)</span>
</span></span></code></pre></div><ol start=3><li>Encrypt the root partition:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ cryptsetup root --encrypt /dev/sdXY --reduce-device-size 16M
</span></span></code></pre></div><ol start=4><li>We open the just created encrypted volume:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ cryptsetup open /dev/sdXY root
</span></span></code></pre></div><ol start=5><li>Resize the filesystem again to expand to all the partition size:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ resize2fs /dev/mapper/root 
</span></span></code></pre></div><ol start=6><li>Then, without leaving the Archlinux live ISO, we mount the root partition unencrypted volume and the existing <code>/boot</code> partition:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ mount /dev/mapper/root /mnt
</span></span><span style=display:flex><span>λ mount /dev/sdaX /mnt/boot
</span></span></code></pre></div><ol start=7><li>Now, we <code>chroot</code> into the installation:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ arch-chroot /mnt
</span></span></code></pre></div><ol start=8><li>While <code>chrooted</code>, perform the following actions:</li></ol><ul><li>Check the root <code>PARTITION</code> UUID:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ blkid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> user:
</span></span><span style=display:flex><span>/dev/sda1: UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;this-is-the-UIID-to-keep&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;crypto_LUKS&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxxxxxx&#34;</span>
</span></span><span style=display:flex><span>/dev/sda2: TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BitLocker&#34;</span> PARTLABEL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Data partition&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>/dev/sda3: UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vfat&#34;</span> PARTLABEL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;EFI partition&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span>/dev/sda4: BLOCK_SIZE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;512&#34;</span> UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xXX&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ntfs&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxxx&#34;</span>
</span></span><span style=display:flex><span>/dev/sda5: PARTLABEL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Microsoft reserved partition&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxxx&#34;</span>
</span></span><span style=display:flex><span>/dev/mapper/root: UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxxx&#34;</span> BLOCK_SIZE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4096&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ext4&#34;</span>
</span></span></code></pre></div><ul><li>Update <code>/etc/fstab</code> root partition with the new UUID:</li></ul><pre tabindex=0><code># Static information about the filesystems.
# See fstab(5) for details.


# /dev/nvme0n1p1
UUID=xxxxxxxxxxxxxxxxx     	/boot     	vfat      	rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro0 2

# /dev/mapper/root
UUID=this-is-the-UIID-to-keep  /         	ext4      	rw,relatime	0 1
</code></pre><ul><li>Update <code>mkinitcpio</code> hooks so you can enter the partition password after boot:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo vim /etc/mkinitcpio.conf <span style=color:#75715e># Edit below line</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HOOKS<span style=color:#f92672>=(</span>base udev autodetect modconf block filesystems keyboard consolefont fsck encrypt<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>λ mkinitcpio -P 
</span></span></code></pre></div><ul><li>Finally, move your GRUB themes to an available location during boot (outside <code>/root</code> partition) and edit GRUB configuration <code>/etc/default/grub</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ  mkdir -p /boot/themes
</span></span><span style=display:flex><span>λ  cp -r /usr/share/grub/themes/Stylish/ /boot/themes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>λ  vim /etc/default/grub
</span></span><span style=display:flex><span>GRUB_CMDLINE_LINUX_DEFAULT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;loglevel=3 quiet cryptdevice=UUID=this-is-the-UIID-to-keep:root root=/dev/mapper/root&#34;</span>
</span></span><span style=display:flex><span>GRUB_ENABLE_CRYPTODISK<span style=color:#f92672>=</span>y
</span></span><span style=display:flex><span>GRUB_THEME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/boot/themes/Stylish/theme.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>λ  grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><blockquote><p><a href=https://wiki.archlinux.org/title/Dm-crypt/Specialties#Discard/TRIM_support_for_solid_state_drives_(SSD)>TRIM Support</a> If you wish to be able to <code>TRIM</code> your device, change <code>GRUB_CMDLINE_LINUX_DEFAULT</code> to:</p></blockquote><pre tabindex=0><code>GRUB_CMDLINE_LINUX_DEFAULT=&#34;loglevel=3 quiet cryptdevice=UUID=f435a66e-28c4-4b78-9ebe-bf87614a6fee:root:allow-discards root=/dev/mapper/root rd.luks.options=discard
</code></pre><p>And enable fstrim timer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ sudo systemctl enable fstrim.timer
</span></span><span style=display:flex><span>λ sudo systemctl start fstrim.timer
</span></span></code></pre></div><ol start=9><li>That&rsquo;s it, exit the <code>chroot</code> environment, umount everything and reboot:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>λ exit
</span></span><span style=display:flex><span>λ umount /mnt
</span></span><span style=display:flex><span>λ cryptsetup close /dev/mapper/root
</span></span><span style=display:flex><span>λ reboot
</span></span></code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://ruben-rodriguez.github.io/posts/minio-s3-terraform-backend/><span class=button__icon>←</span>
<span class=button__text>Selfhosted S3 Terraform Backend using MinIO</span></a></span>
<span class="button next"><a href=https://ruben-rodriguez.github.io/posts/kube-prom-stack-blackbox/><span class=button__text>Endpoints Monitoring - BlackBox Exporter</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Ruben Rodriguez</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://ruben-rodriguez.github.io/assets/main.js></script>
<script src=https://ruben-rodriguez.github.io/assets/prism.js></script></div></body></html>